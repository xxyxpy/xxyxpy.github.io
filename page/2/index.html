<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>code dog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="什么鬼...">
<meta property="og:type" content="website">
<meta property="og:title" content="code dog">
<meta property="og:url" content="http://xxyxpy.pub/page/2/index.html">
<meta property="og:site_name" content="code dog">
<meta property="og:description" content="什么鬼...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="code dog">
<meta name="twitter:description" content="什么鬼...">
    

    
        <link rel="alternate" href="/" title="code dog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">code dog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Buscar" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Entradas',
            PAGES: 'Pages',
            CATEGORIES: 'Categorias',
            TAGS: 'Etiquetas',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Buscar" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">PPOffice</h2>
            <h3 id="title">Web Developer &amp; Designer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Harbin, China</span>
            <a id="follow" target="_blank" href="https://github.com/ppoffice/">SEGUIR</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                48
                <span>Entradas</span>
            </div>
            <div class="article-info-block">
                41
                <span>Etiquetas</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-nosql/mongodb入门" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/26/nosql/mongodb入门/">mongodb入门</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/26/nosql/mongodb入门/">
            <time datetime="2017-10-26T09:53:23.630Z" itemprop="datePublished">2017-10-26</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/nosql/">nosql</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mongodb/">mongodb</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装64位的环境，因为32位的最大只支持2G存储。可以到<a href="https://www.mongodb.com" target="_blank" rel="external">官网</a>下载，即将安装的环境为Centos 7.3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 上传到服务器解压文件到指定位置</div><div class="line">tar -zxf mongodb-linux-x86_64-rhel70-3.4.9.tgz</div><div class="line">mv mongodb-linux-x86_64-rhel70-3.4.9 /usr/local/mongodb</div><div class="line"></div><div class="line"># 添加参数到环境变量</div><div class="line">vim /etc/profile</div><div class="line"># 添加的内容</div><div class="line">export MONGODB_HOME=/usr/local/mongodb</div><div class="line">export PATH=$MONGODB_HOME/bin:$PATH</div><div class="line"></div><div class="line"># 添加完成之后重新加载环境变量</div><div class="line">source /etc/profile</div></pre></td></tr></table></figure>
<hr>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"># 创建数据库目录</div><div class="line">mkdir -p /data/mongodb</div><div class="line">mkdir -p /data/mongodb/log</div><div class="line">touch /data/mongodb/log/mongodb.log</div><div class="line"></div><div class="line"># 添加配置文件</div><div class="line">vim /etc/mongodb.conf</div><div class="line"># 配置文件内容</div><div class="line">dbpath=/data/mongodb</div><div class="line">logpath=/data/mongodb/log/mongodb.log</div><div class="line">logappend=true</div><div class="line">port=27017</div><div class="line">fork=true</div><div class="line">#auth = true # 先关闭, 创建好用户在启动</div><div class="line"></div><div class="line"># 通过配置文件启动</div><div class="line">mongod -f /etc/mongodb.conf</div><div class="line"></div><div class="line"># 连接mongodb服务，通过mongo命令，由于已经添加到环境变量可以直接使用</div><div class="line">mongo</div><div class="line"></div><div class="line"># 从Mongodb的admin中关闭系统</div><div class="line">use admin</div><div class="line">db.shutdownServer()</div></pre></td></tr></table></figure>
<p>配置文件参数说明</p>
<blockquote>
<p>mongodb的参数说明：<br>–dbpath 数据库路径(数据文件)<br>–logpath 日志文件路径<br>–master 指定为主机器<br>–slave 指定为从机器<br>–source 指定主机器的IP地址<br>–pologSize 指定日志文件大小不超过64M.因为resync是非常操作量大且耗时，最好通过设置一个足够大的oplogSize来避免resync(默认的 oplog大小是空闲磁盘大小的5%)。<br>–logappend 日志文件末尾添加<br>–port 启用端口号<br>–fork 在后台运行<br>–only 指定只复制哪一个数据库<br>–slavedelay 指从复制检测的时间间隔<br>–auth 是否需要验证权限登录(用户名和密码)</p>
<p>注：mongodb配置文件里面的参数很多，定制特定的需求，请参考官方文档</p>
</blockquote>
<hr>
<h3 id="通过Robo连接"><a href="#通过Robo连接" class="headerlink" title="通过Robo连接"></a>通过Robo连接</h3><p>因为mongodb是基于json进行操作的，所以在命令行中操作时非常的麻烦。使用可视化工具Robo去访问和操作更方便，提供了linux和windows两种版本。下载地址如下：</p>
<blockquote>
<p>链接: <a href="https://pan.baidu.com/s/1c1ZCkBu" target="_blank" rel="external">https://pan.baidu.com/s/1c1ZCkBu</a> 密码: 53n5</p>
</blockquote>
<p>在连接之前需要先开放默认的27017端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 可以关闭防火墙，或者单独添加27017端口</div><div class="line">chkconfig iptables off</div><div class="line"></div><div class="line">/sbin/iptables -I INPUT -p tcp --dport 27017 -j ACCEPT</div><div class="line">/etc/rc.d/init.d/iptables save</div><div class="line">/etc/rc.d/init.d/iptables restart</div></pre></td></tr></table></figure>
<p>然后安装robo后直接connect即可。</p>
<hr>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><ul>
<li>Object ID：文档ID。每个文档都有一个_id，如果不设置的话会默认生成一个12个字节的16进制数。前4个字节为当前的时间戳，接下来3个字节为机器id，接下来2个字节为MongoDb的服务进程id，最后三个字节是增量值</li>
<li>String：字符串，最常用，必须是有效的UTF-8</li>
<li>Boolean：存储一个布尔值，true或false</li>
<li>Integer：整数可以是32位或64位，这取决于服务器</li>
<li>Double：存储浮点值</li>
<li>Arrays：数组或列表，多个值存储到一个键</li>
<li>Object：用于嵌入式的文档，即一个值为一个文档</li>
<li>Null：存储Null值</li>
<li>Timestamp：时间戳</li>
<li>Date：存储当前日期或时间的UNIX时间格式</li>
</ul>
<hr>
<h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><p>默认连接的是test数据库，如果不创建数据库直接进行操作则操作的数据会存放在test数据库中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 查看当前的数据库</div><div class="line">db</div><div class="line"># 显示所连接服务上面的所有数据库</div><div class="line">show dbs</div><div class="line"># 切换数据库，如果不存在仅指向数据库，不执行创建，只有当插入数据或创建集合时才创建库</div><div class="line">use mydb</div><div class="line"># 删除数据库，执行此操作时删除当前连接的数据库</div><div class="line">db.dropDatebase()</div></pre></td></tr></table></figure>
<hr>
<h3 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h3><ul>
<li><p>显示所有集合</p>
<blockquote>
<p>show collections</p>
</blockquote>
</li>
<li><p>创建集合 <code>db.createCollection(name, options)</code></p>
<blockquote>
<p>db.createCollection(“stu”)</p>
<p>可选参数options，capped 表示设置上限，size 表示最大字节的大小。max表示最大的文档数量。当capped为true时size必须指定</p>
<p>db.createCollection(“sub”, { capped : true, size : 10 } )</p>
</blockquote>
</li>
<li><p>删除集合</p>
<blockquote>
<p>db.集合名.drop()</p>
</blockquote>
</li>
</ul>
<hr>
<h3 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h3><ul>
<li><p>插入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 不指定_id参数，mongodb自动分配</div><div class="line">db.stu.insert(&#123;name:'gj',gener:1&#125;)</div><div class="line"># 指定_id参数</div><div class="line">s1=&#123;_id:'20160101',name:'hr'&#125;</div><div class="line">s1.gender=0</div><div class="line">db.stu.insert(s1)</div></pre></td></tr></table></figure>
</li>
<li><p>查询全部</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.stu.find()</div></pre></td></tr></table></figure>
</li>
<li><p>更新</p>
<p>语法</p>
<blockquote>
<p>db.集合.update({queryjson},{updatejson},{multi:true or false})</p>
<p>queryjson指的是查询条件，类似于update中的where。无条件时也要写{}</p>
<p>updatejson指的是更新的数据</p>
<p>multi是可选项，默认值是false表示只更新查找到的第一条记录。值为true时表示更新所有</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 更新所有的文档，可能会造成其它属性的丢失</div><div class="line">db.stu.update(&#123;name:'hr'&#125;,&#123;name:'mnc'&#125;)</div><div class="line"># 指定属性更新，使用$set操作符</div><div class="line">db.stu.update(&#123;name:'gj'&#125;,&#123;$set:&#123;name:'gj1'&#125;&#125;)</div><div class="line"># 修改多条匹配的数据，如果没有gender属性会自动添加</div><div class="line">db.stu.update(&#123;&#125;,&#123;$set:&#123;gender:0&#125;&#125;,&#123;multi:true&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>保存</p>
<p>语法</p>
<blockquote>
<p>db.集合.save({savejson})</p>
<p>如果文档的_id存在则修改，如果不存在则插入</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 更新</div><div class="line">db.stu.save(&#123;_id:'20160101',name:'haha',gender:1&#125;)</div><div class="line"># 添加</div><div class="line">db.stu.save(&#123;name:'jack',gender:1&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>删除</p>
<p>语法</p>
<blockquote>
<p>db.集合.remove({queryjson},{justOne:true or false})</p>
<p>justOne 表示是否只删除一行，默认是false删除多行。</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 只删除一条</div><div class="line">db.stu.remove(&#123;gender:0&#125;,&#123;justOne:true&#125;)</div><div class="line"># 全部删除</div><div class="line">db.stu.remove(&#123;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>有size限制的集合插入</p>
<p>当插入的数据超过限制的max大小时，后面插入的数据会覆盖前面插入的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">db.createCollection('sub',&#123;capped:true,size:3,max:3&#125;)</div><div class="line">db.sub.insert(&#123;name:'zs',age:18&#125;)</div><div class="line">db.sub.insert(&#123;name:'ls',age:19&#125;)</div><div class="line">db.sub.insert(&#123;name:'ww',age:20&#125;)</div><div class="line"># 覆盖第一条数据</div><div class="line">db.sub.insert(&#123;name:'zl',age:21&#125;)</div><div class="line">db.sub.find()</div></pre></td></tr></table></figure>
<hr>
</li>
</ul>
<h3 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h3><ul>
<li><p>基本查询</p>
<p>语法</p>
<blockquote>
<p>db.集合.find({queryjson})</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 查询全部</div><div class="line">db.sub.find()</div><div class="line"># 带条件查询</div><div class="line">db.sub.find(&#123;age:20&#125;)</div><div class="line"># 只返回符合条件的第一个findOne()</div><div class="line">db.sub.update(&#123;age:19&#125;,&#123;$set:&#123;age:20&#125;&#125;)</div><div class="line">db.sub.finOne(&#123;age:20&#125;)</div><div class="line"># 格式化查询结果pretty()，只在命令行窗口时有效果</div><div class="line">db.sub.find(&#123;age:20&#125;).pretty()</div></pre></td></tr></table></figure>
</li>
<li><p>比较运算符</p>
<blockquote>
<p> 等于，默认是等于判断，没有运算符</p>
<p> 小于$lt</p>
<p> 小于等于$lte</p>
<p> 大于$gt</p>
<p> 大于等于$gte</p>
<p> 不等于$ne</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 查询年龄大于20的记录</div><div class="line">db.sub.find(&#123;age:&#123;$gt:20&#125;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>逻辑运算符</p>
<blockquote>
<p>逻辑运算符指并且或者之类的关系，查询时可以有多个条件</p>
<p>多个条件之前使用逻辑运算符连接</p>
<p>逻辑与：默认查询时的json就是逻辑与的关系，用逗号隔开</p>
<p>逻辑或：使用$or</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 多个逻辑与条件：查询年龄大于等于20并且name为ww的记录</div><div class="line">db.sub.find(&#123;age:&#123;$gte:20&#125;,name:'ww'&#125;)</div><div class="line"># 使用逻辑或$or：查询name为zl或者年龄等于20的记录</div><div class="line">db.sub.find(&#123;$or:[&#123;name:'zl'&#125;,&#123;age:20&#125;]&#125;)</div><div class="line"># 逻辑与和或一起使用：查询name为zl或者年龄大于等于20 并且name为ls的记录</div><div class="line">db.sub.find(&#123;$or:[&#123;name:'zl'&#125;,&#123;age:&#123;$gte:20&#125;&#125;],name:'ls'&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>范围运算符</p>
<blockquote>
<p>使用<code>$in</code>和<code>$nin</code>判断是否在某个范围内</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 查询年龄为10或20的记录</div><div class="line">db.sub.find(&#123;age:&#123;$in:[10,20]&#125;&#125;)</div><div class="line"># 查询年龄不为10或20的记录</div><div class="line">db.sub.find(&#123;age:&#123;$nin:[10,20]&#125;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>正则表达式查询</p>
<blockquote>
<p>使用//或$regex编写正则表达式</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 查询name以l开头的记录</div><div class="line">db.sub.find(&#123;name:/^l/&#125;)</div><div class="line">db.sub.find(&#123;name:&#123;$regex:'^l'&#125;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>自定义函数查询</p>
<blockquote>
<p>使用js中的function来进行查询返回，用$where</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 查询年龄大于20的记录</div><div class="line">db.sub.find(&#123;$where:function()&#123;</div><div class="line">	return this.age&gt;20</div><div class="line">&#125;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>使用limit和skip分页</p>
<blockquote>
<p>limit用于读取指定数量的文档</p>
<p>db.集合.find({queryjson}).limit(number)</p>
<p>skip用于跳过指定数量的文档</p>
<p>db.集合.find({queryjson}).skip(number)</p>
<p>两者搭配使用可以实现分页查询的功能</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 向stu中添加测试数据</div><div class="line">db.stu.insert(&#123;name:'zhangsan',gender:1,age:23&#125;</div><div class="line">db.stu.insert(&#123;name:'lisi',gender:1,age:33&#125;</div><div class="line">db.stu.insert(&#123;name:'wangwu',gender:0,age:13&#125;</div><div class="line">db.stu.insert(&#123;name:'zhaoliu',gender:0,age:40&#125;</div><div class="line">db.stu.insert(&#123;name:'wangerma',gender:1,age:30&#125;</div><div class="line"># 查询gender为0，只取前两条</div><div class="line">db.stu.find(&#123;gender:0&#125;).limit(2)</div><div class="line"># 查询age大于20记录，跳过前两条</div><div class="line">db.stu.find(&#123;age:&#123;$gt:20&#125;&#125;).skip(2)</div><div class="line"></div><div class="line"># 生成分页测试数据</div><div class="line">for(i=0;i&lt;15;i++)&#123;</div><div class="line">	db.t1.insert(&#123;name:'name' + i, age:i&#125;)</div><div class="line">&#125;</div><div class="line"># 每页3条，查询第3页数据</div><div class="line">db.t1.find().skip(6).limit(3)</div></pre></td></tr></table></figure>
</li>
<li><p>投影查询</p>
<blockquote>
<p>指定需要输出的文档字段，防止输出不必要的字段造成性能的下降</p>
<p>db.集合.find({queryjson},{col1:1,col2:0,col3:1…})</p>
<p>对于需要显示的字段，设置值为1。不设置不显示</p>
<p>对于_id默认显示，如果不显示需要显示的设置为0</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 只展示name和_id</div><div class="line">db.stu.find(&#123;&#125;,&#123;name:1&#125;)</div><div class="line"># 只展示name</div><div class="line">db.stu.find(&#123;&#125;,&#123;name:1,_id:0&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>排序</p>
<blockquote>
<p>使用sort()对结果集进行排序</p>
<p>db.集合.find({queryjson}).sort({col1:1,col2:-1,…})</p>
<p>参数1为升序，-1为降序</p>
<p>多个条件时逗号分隔</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 查询age大于0的数据，按性别降序再按age升序</div><div class="line">db.stu.find(&#123;age:&#123;$gt:0&#125;&#125;).sort(&#123;gender:-1,age:1&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>统计个数</p>
<blockquote>
<p>使用count()进行文档数的统计，提供两种语法</p>
<p>db.集合.find({queryjson}).count()</p>
<p>db.集合.cont({queryjson})</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 统计age大于0的文档数</div><div class="line">db.stu.find(&#123;age:&#123;$gt:0&#125;&#125;).count()</div><div class="line">db.stu.count(&#123;age:&#123;$gt:0&#125;&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>消除重复</p>
<blockquote>
<p>方法distinct()对数据进行去重</p>
<p>db.集合.distinct(‘column’,{conditionjson})</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 查找age大于18的性别，去重</div><div class="line">db.stu.distinct('gender',&#123;age:&#123;$gt:18&#125;&#125;)</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul>
<li><p>生成测试数据100W条</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">use test3</div><div class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++)&#123;db.t1.insert(&#123;<span class="attr">name</span>:<span class="string">'name'</span>+i&#125;)&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>查看查询的执行计划</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">db.t1.find(&#123;name:'name500000'&#125;).explain('executionStats')</div><div class="line"># 显示内容中主要关注时间</div><div class="line">...</div><div class="line">"executionTimeMillis" : 303,</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p>创建索引</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 1指为按升序创建索引，-1表示降序</div><div class="line">db.t1.ensureIndex(&#123;"name":1&#125;)</div><div class="line"># 也支持同时为多个字段创建索引，即关系型数据库中的复合索引。如</div><div class="line">db.collectionName.ensureIndex(&#123;'col1':1,'col2':-1&#125;)</div><div class="line"># 在后台创建索引</div><div class="line">db.collectionName.ensureIndex(&#123;'col1':1,'col2':-1&#125;,&#123;background:true&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>索引创建完成之后再次查看执行计划</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">db.t1.find(&#123;name:'name500000'&#125;).explain('executionStats')</div><div class="line"># 显示内容中主要关注时间,变化为86ms，说明索引的效果还是比较明显的</div><div class="line">...</div><div class="line">"executionTimeMillis" : 86,</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><blockquote>
<p>聚合主要用于计算数据，类似sql中的sum()、avg()</p>
<p>语法：</p>
<p>db.集合.aggregate([{管道:{表达式}},{管道:{表达式}},…])</p>
<p>常用管道</p>
<p>文档处理完毕后，通过管道进行下一次处理</p>
<ul>
<li>$group：将集合中的文档分组，可用于统计结果</li>
<li>$match：过滤数据，只输出符合条件的文档</li>
<li>$project：修改输入文档的结构，如重命名、增加、删除字段、创建计算结果</li>
<li>$sort：将输入文档排序后输出</li>
<li>$limit：限制聚合管道返回的文档数</li>
<li>$skip：跳过指定数量的文档，并返回余下的文档</li>
<li>$unwind：将数组类型的字段进行拆分</li>
</ul>
<p>表达式</p>
<p>处理输入文档并输出</p>
<p>语法：’$列名’</p>
<p>常用表达式：</p>
<ul>
<li><code>$sum</code>：计算总和， <code>$sum</code>:1同count表示计数</li>
<li>$avg：计算平均值</li>
<li>$min：获取最小值</li>
<li>$max：获取最大值</li>
<li>$push：在结果文档中插入值到一个数组中</li>
<li>$first：根据资源文档的排序获取第一个文档数据</li>
<li>$last：根据资源文档的排序获取最后一个文档数据</li>
</ul>
</blockquote>
<ul>
<li><p>$group</p>
<blockquote>
<p>将集合中的文档分组，可用于统计结果</p>
<p>_id表示分组的依据，使用某个字段时格式为：$字段</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"># 统计gender的总人数 使用$sum表达式</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$group:&#123;</div><div class="line">			_id:'$gender',</div><div class="line">			counter:&#123;$sum:1&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div><div class="line"># 将集合中所有的文档分成一组_id:null。统计学生总人数，平均年龄</div><div class="line"># 使用$avg表达式</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$group:&#123;</div><div class="line">			_id:null,</div><div class="line">			counter:&#123;$sum:1&#125;,</div><div class="line">			avgAge:&#123;$avg:'$age'&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div><div class="line"></div><div class="line"># 透视数据。统计学生的性别及对应的学生姓名</div><div class="line"># 使用$push表达式，将结果推到数组中</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$group:&#123;</div><div class="line">			_id:'$gender',</div><div class="line">			name:&#123;$push:'$name'&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div><div class="line"># 使用$$ROOT可以将文档内容整个加入到结果集的数组中</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$group:&#123;</div><div class="line">			_id:'$gender',</div><div class="line">			name:&#123;$push:'$$ROOT'&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div></pre></td></tr></table></figure>
</li>
<li><p>$match</p>
<blockquote>
<p>用于过滤数据，只输出符合条件的文档</p>
<p>使用标准的查询操作</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"># 查询年龄大于20的学生</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$match:&#123;</div><div class="line">			age:&#123;$gt:20&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div><div class="line"># 统计年龄大于20的男女生人数</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$match:&#123;</div><div class="line">			age:&#123;$gt:20&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		$group:&#123;</div><div class="line">			_id:'$gender',</div><div class="line">			counter:&#123;</div><div class="line">				$sum:1</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div></pre></td></tr></table></figure>
</li>
<li><p>$project</p>
<blockquote>
<p>修改输入文档的结构，如重命名、增加、删除字段、创建计算结果</p>
<p>类似于投影查询的实现</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 查询学生的姓名及年龄</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$project:&#123;</div><div class="line">			_id:0,</div><div class="line">			name:1,</div><div class="line">			age:1</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">])</div><div class="line"># 统计男女生人数，返回指定的字段</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;</div><div class="line">		$group:&#123;_id:'$gender',counter:&#123;$sum:1&#125;&#125;</div><div class="line">	&#125;,</div><div class="line">	&#123;</div><div class="line">		$project:&#123;_id:0,counter:1&#125;</div><div class="line">	&#125;</div><div class="line">])</div></pre></td></tr></table></figure>
</li>
<li><p>$sort</p>
<blockquote>
<p>将输入文档排序后输出</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 查询学生信息，按年龄升序</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;$sort:&#123;$age:1&#125;&#125;</div><div class="line">])</div><div class="line"># 统计男女生人数，按总人数降序</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;$group:&#123;_id:'$gender',counter:&#123;$sum:1&#125;&#125;&#125;,</div><div class="line">	&#123;$sort:&#123;counter:-1&#125;&#125;</div><div class="line">])</div></pre></td></tr></table></figure>
</li>
<li><p>$limit 、\$skip</p>
<blockquote>
<p>$limit用于限制管道返回的文档数</p>
<p>$skip用于跳过指定数量的文档，并返回余下的文档</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">db.stu.aggregate([</div><div class="line">	&#123;$limit:2&#125;</div><div class="line">])</div><div class="line"></div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;$skip:2&#125;</div><div class="line">])</div><div class="line"># 统计男生、女生人数，按人数升序，取第二条数据</div><div class="line">db.stu.aggregate([</div><div class="line">	&#123;$group:&#123;_id:'$gender',counter:&#123;$sum:1&#125;&#125;&#125;,</div><div class="line">	&#123;$sort:&#123;counter:1&#125;&#125;,</div><div class="line">	&#123;$skip:1&#125;,</div><div class="line">	&#123;$limit:1&#125;</div><div class="line">])</div></pre></td></tr></table></figure>
</li>
<li><p>$unwind</p>
<blockquote>
<p>将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值</p>
<p>正常数据处理语法</p>
<p>db.集合.aggregate([{$unwind:’\$字段名称’}])</p>
<p>处理空数组、非数组、null、无此字段的情况</p>
<p>db.集合.aggregate([{$unwind:{</p>
<p>​    path:’$字段名称’,</p>
<p>​    preserveNullAndEmptyArrays:true or false</p>
<p>}}])</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># 正常数据</div><div class="line">db.t2.insert(&#123;_id:1,item:'t-shirt',size:['s','m','l']&#125;)</div><div class="line">db.t2.aggregate([</div><div class="line">	&#123;$unwind:'$size'&#125;</div><div class="line">])</div><div class="line"></div><div class="line"># 空数组，非数组，null，无数据的情况</div><div class="line">db.t3.insert([</div><div class="line">	&#123;_id:1,item:'a',size:['s','m','l']&#125;,</div><div class="line">	&#123;_id:2,item:'b',size:[]&#125;,</div><div class="line">	&#123;_id:3,item:'c',size:['m']&#125;,</div><div class="line">	&#123;_id:4,item:'d'&#125;,</div><div class="line">	&#123;_id:5,item:'e',size:null&#125;</div><div class="line">])</div><div class="line"># 使用此语法时数据会丢失</div><div class="line">db.t3.aggregate([</div><div class="line">	&#123;$unwind:'$size'&#125;</div><div class="line">])</div><div class="line"></div><div class="line">db.t3.aggregate([</div><div class="line">	&#123;$unwind:&#123;</div><div class="line">		path:'$size',</div><div class="line">		preserveNullAndEmptyArrays:true</div><div class="line">	&#125;&#125;</div><div class="line">])</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h3><p>mongodb默认不开启用户认证，直接通过ip和端口号即可完成连接。如果需要开启权限管理需要修改配置文件<code>mongodb.conf</code></p>
<p>采用用户-角色-数据库的安全管理方式。一个用户可以对应多个角色</p>
<blockquote>
<p>角色说明：<br>Read：允许用户读取指定数据库<br>readWrite：允许用户读写指定数据库<br>dbAdmin：允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile<br>userAdmin：允许用户向system.users集合写入，可以找指定数据库里创建、删除和管理用户<br>clusterAdmin：只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限。<br>readAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读权限<br>readWriteAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读写权限<br>userAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的userAdmin权限<br>dbAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限。<br>root：只在admin数据库中可用。超级账号，超级权限</p>
</blockquote>
<p>修改之前需要先创建一个超级管理员帐户，否则无法完成登录。如果遇到服务无法停止的情况下可以kill掉服务的进程</p>
<blockquote>
<p>查询mongodb的服务的pid</p>
<p>ps aux | grep mongo</p>
<p>找到pid杀掉，比如pid为100</p>
<p>kill 100</p>
</blockquote>
<ul>
<li><p>创建管理员帐户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 连接到mongo</div><div class="line">mongo</div><div class="line"># 进入到admin库</div><div class="line">use admin</div><div class="line"># 添加用户</div><div class="line">db.createUser(</div><div class="line">   &#123;</div><div class="line">     user: &quot;admin&quot;,</div><div class="line">     pwd: &quot;mongodb:passok&quot;,</div><div class="line">     roles: [ &#123; role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; &#125; ]</div><div class="line">   &#125;</div><div class="line">)</div><div class="line"># 查看用户</div><div class="line">show users</div><div class="line">db.system.users.find()</div><div class="line"># 停止服务</div><div class="line">db.shutdownServer()</div></pre></td></tr></table></figure>
</li>
<li><p>开启权限认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 添加内容到配置文件</div><div class="line">echo &quot;auth = true&quot; &gt;&gt; /etc/mongodb.conf</div><div class="line"># 启动服务</div><div class="line">mongod -f /etc/mongodb.conf</div></pre></td></tr></table></figure>
</li>
<li><p>登录验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mongod</div><div class="line"># 无权限查看所有的库</div><div class="line">show dbs</div><div class="line">use admin</div><div class="line"># 登录</div><div class="line">db.auth(&apos;admin&apos;,&apos;mongodb:passok&apos;)</div><div class="line"># 登录成功</div><div class="line">show dbs</div><div class="line"></div><div class="line"># 也可以使用以下方式进行登录</div><div class="line">mongo -u &apos;admin&apos; -p &apos;mongodb:passok&apos; --authenticationDatabase &apos;admin&apos;</div></pre></td></tr></table></figure>
</li>
<li><p>创建修改用户</p>
<p>使用超级管理员登录之后可以创建普通用户，使用户只有特定的数据库的访问权限</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">db.createUser(&#123;</div><div class="line">    user:'t1',</div><div class="line">    pwd:'123',</div><div class="line">    roles:[&#123;role:'readWrite',db:'test1'&#125;]</div><div class="line">&#125;)</div><div class="line"># 连接</div><div class="line">mongo -u t1 -p 123 --authenticationDatabase test1</div><div class="line"># 添加数据</div><div class="line">db.t1.insert(&#123;name:'ls'&#125;)</div><div class="line"># 修改用户，必须使用admin帐户操作</div><div class="line">use test1</div><div class="line">db.updateUser('t1',&#123;pwd:'456'&#125;)</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>为了保证服务的持续可用，可以设置多台服务器进行数据同步。在主服务器出现故障时可以自动切换到从节点，此时从节点自动变成为主节点。要搭建此套服务至少需要两台服务器，实现的机制是每隔一段时间自动拷贝所有的改动到从节点。</p>
<ul>
<li><p>创建两个数据库目录t1、t2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir t1</div><div class="line">mkdir t2</div></pre></td></tr></table></figure>
</li>
<li><p>启动两个mongod服务，replSet的名称相同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 主</div><div class="line">mongod --bind_ip 192.168.80.129 --port 27018 --dbpath /root/t1 --replSet rs0</div><div class="line"># 从</div><div class="line">mongod --bind_ip 192.168.80.129 --port 27019 --dbpath /root/t2 --replSet rs0</div></pre></td></tr></table></figure>
</li>
<li><p>操作主节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mongo --host 192.168.80.129 --port 27018</div><div class="line"># 初始化</div><div class="line">rs.initiate() # rs是mongodb的内置对象</div><div class="line"># 查看当前状态，members中只有一个服务</div><div class="line">rs.status()</div><div class="line"># 添加从节点，可以添加多个</div><div class="line">rs.add(&apos;192.168.80.129:27019&apos;)</div><div class="line"># 查看当前状态，members中有两个服务。并且此时提示符变为：rs0:PRIMARY</div><div class="line">rs.status()</div><div class="line"># 向主节点中插入数据</div><div class="line">use test1</div><div class="line">for(i=0;i&lt;10;i++)&#123;db.t1.insert(&#123;_id:i&#125;)&#125;</div><div class="line">db.t1.find()</div></pre></td></tr></table></figure>
</li>
<li><p>操作从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 连接，提示符为：rs0:SECONDARY</div><div class="line">mongo --host 192.168.80.129 --port 27019</div><div class="line"># 设置slave，否则无法查询数据</div><div class="line">rs.slaveOk()</div><div class="line">use test1</div><div class="line">db.t1.find()</div></pre></td></tr></table></figure>
</li>
<li><p>删除从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.remove(&apos;192.168.80.129:27019&apos;)</div></pre></td></tr></table></figure>
</li>
<li><p>主从切换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 关闭主节点重新启动，发现从节点自动变化为主节点</div><div class="line"># Member 192.168.80.129:27019 is now in state PRIMARY</div><div class="line"># 连接原来的主节点提示符为：rs0:SECONDARY&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h3><ul>
<li><p>备份</p>
<blockquote>
<p>语法</p>
<p>mongodump -h dbhost -d dbname -o dbdirectory</p>
<p>-h：服务器地址，也可以指定端口号</p>
<p>-d：需要备份的数据库名称</p>
<p>-o：备份的数据存放位置，此目录中存放着备份出来的数据</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir test1bak</div><div class="line">mongodump -h 192.168.80.129:27019 -d test1 -o ~/test1bak</div></pre></td></tr></table></figure>
</li>
<li><p>恢复</p>
<blockquote>
<p>语法</p>
<p>mongorestore -h dbhost -d dbname –dir dbdirectory</p>
<p>-h：服务器地址</p>
<p>-d：需要恢复的数据库实例</p>
<p>–dir：备份数据所在位置</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongorestore -h 192.168.80.129:27018 -d test2 --dir ~/test1bak/test1</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<p>参考：</p>
<p><a href="https://itjh.net/2016/07/11/centos-install-mongodb/" target="_blank" rel="external">CentOS下安装mongodb</a></p>
<p><a href="http://www.jianshu.com/p/a4e94bb8a052" target="_blank" rel="external">Mongodb用户权限管理</a></p>
<p><a href="http://www.runoob.com/mongodb/mongodb-indexing.html" target="_blank" rel="external">Mongodb索引</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/10/26/nosql/mongodb入门/" data-id="cj9zcpp92001iishqr3ygvnae" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-common/激活码" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/17/common/激活码/">software key</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/17/common/激活码/">
            <time datetime="2017-10-17T01:44:54.828Z" itemprop="datePublished">2017-10-17</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/激活码/">激活码</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/激活码/">激活码</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="SQLyog"><a href="#SQLyog" class="headerlink" title="SQLyog"></a>SQLyog</h3><blockquote>
<p>姓名（Name）：cr173</p>
<p>序列号（Code）：8d8120df-a5c3-4989-8f47-5afc79c56e7c</p>
<p>或者（OR）</p>
<p>姓名（Name）：cr173</p>
<p>序列号（Code）：59adfdfe-bcb0-4762-8267-d7fccf16beda</p>
<p>或者（OR）</p>
<p>姓名（Name）：cr173</p>
<p>序列号（Code）：ec38d297-0543-4679-b098-4baadf91f983</p>
</blockquote>
<hr>
<h3 id="VS-2017"><a href="#VS-2017" class="headerlink" title="VS 2017"></a>VS 2017</h3><blockquote>
<p>Visual Studio 2017（VS2017） 企业版Enterprise 注册码：NJVYC-BMHX2-G77MM-4XJMR-6Q8QF</p>
<p>Visual Studio 2017（VS2017） 专业版Professional 激活码key：KBJFW-NXHK6-W4WJM-CRMQB-G3CDH</p>
</blockquote>
<hr>
<h3 id="Sublime-3-x"><a href="#Sublime-3-x" class="headerlink" title="Sublime 3.x"></a>Sublime 3.x</h3><p>after Build 3133，<a href="https://9iphp.com/web/html/sublime-text-3-license-key.html" target="_blank" rel="external">other version</a> </p>
<blockquote>
<p>—– BEGIN LICENSE —–<br>TwitterInc<br>200 User License<br>EA7E-890007<br>1D77F72E 390CDD93 4DCBA022 FAF60790<br>61AA12C0 A37081C5 D0316412 4584D136<br>94D7F7D4 95BC8C1C 527DA828 560BB037<br>D1EDDD8C AE7B379F 50C9D69D B35179EF<br>2FE898C4 8E4277A8 555CE714 E1FB0E43<br>D5D52613 C3D12E98 BC49967F 7652EED2<br>9D2D2E61 67610860 6D338B72 5CF95C69<br>E36B85CC 84991F19 7575D828 470A92AB<br>—— END LICENSE ——</p>
</blockquote>
<hr>
<h3 id="SecureCRT"><a href="#SecureCRT" class="headerlink" title="SecureCRT"></a>SecureCRT</h3><p><a href="http://www.cnblogs.com/qingtingzhe/articles/5008902.html" target="_blank" rel="external">安装及破解</a></p>
<hr>
<h3 id="VmWare"><a href="#VmWare" class="headerlink" title="VmWare"></a>VmWare</h3><blockquote>
<p>5A02H-AU243-TZJ49-GTC7K-3C61N<br>VF5XA-FNDDJ-085GZ-4NXZ9-N20E6<br>UC5MR-8NE16-H81WY-R7QGV-QG2D8<br>ZG1WH-ATY96-H80QP-X7PEX-Y30V4<br>AA3E0-0VDE1-0893Z-KGZ59-QGAVF</p>
</blockquote>
<hr>
<h3 id="EditPlus"><a href="#EditPlus" class="headerlink" title="EditPlus"></a>EditPlus</h3><blockquote>
<p>注册名：host1991<br>​    序列号：14F50-CD5C8-E13DA-51100-BAFE6</p>
<p>​    注册名：360xw<br>​    注册码：93A52-85B80-A3308-BF130-40412</p>
<p>​    注册名：kariryo<br>​    注册码：5387D-12450-BCZ8B-D6W0B-85TE1</p>
<p>​    注册名：crsky<br>​    注册码：7879E-5BF58-7DR23-DAOB2-7DR30</p>
<p>​    注册名：zzidc<br>​    注册码：11276-E9720-D59E6-BD0E0-2965C</p>
<p>​    注册名：gainet<br>​    注册码：74E92-05B20-3D39C-90E5F-A55E8</p>
<p>​    注册名：kuaiyun<br>​    注册码：9152C-84978-1A3E3-64290-992FD</p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/10/17/common/激活码/" data-id="cj9zcpp8e000jishq1qht4qof" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-linux/nginx环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/28/linux/nginx环境搭建/">nginx环境搭建</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/28/linux/nginx环境搭建/">
            <time datetime="2017-09-28T07:36:45.698Z" itemprop="datePublished">2017-09-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/linux/">linux</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/linux/">linux</a>, <a class="tag-link" href="/tags/nginx/">nginx</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><p>gcc 安装nginx需要先将官网下载的源码进行编译，编译依赖gcc环境，如果没有gcc环境，需要安装gcc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install gcc-c++</div></pre></td></tr></table></figure>
<p>PCRE PCRE(PerlCompatible Regular Expressions)是一个Perl库，包括 perl 兼容的正则表达式库。nginx的http模块使用pcre来解析正则表达式，所以需要在linux上安装pcre库。</p>
<p>注：pcre-devel是使用pcre开发的一个二次开发库。nginx也需要此库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y pcre pcre-devel</div></pre></td></tr></table></figure>
<p>zlib zlib库提供了很多种压缩和解压缩的方式，nginx使用zlib对http包的内容进行gzip，所以需要在linux上安装zlib库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y zlib zlib-devel</div></pre></td></tr></table></figure>
<p>openssl OpenSSL是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。nginx不仅支持http协议，还支持https（即在ssl协议上传输http），所以需要在linux安装openssl库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y openssl openssl-devel</div></pre></td></tr></table></figure>
<hr>
<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>将nginx-1.8.0.tar.gz拷贝至linux服务器并解压：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar -zxf nginx-1.8.0.tar.gz</div><div class="line">cd nginx-1.8.0</div></pre></td></tr></table></figure>
<p><strong>配置 configure</strong></p>
<p>\表示命令未结束</p>
<p>prefix 表示要安装的目录</p>
<p>将临时文件目录指定为/var/temp/nginx，需要在/var下创建temp及nginx目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">./configure \</div><div class="line">--prefix=/usr/local/application/nginx \</div><div class="line">--pid-path=/var/run/nginx/nginx.pid \</div><div class="line">--lock-path=/var/lock/nginx.lock \</div><div class="line">--error-log-path=/var/log/nginx/error.log \</div><div class="line">--http-log-path=/var/log/nginx/access.log \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--http-client-body-temp-path=/var/temp/nginx/client \</div><div class="line">--http-proxy-temp-path=/var/temp/nginx/proxy \</div><div class="line">--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \</div><div class="line">--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \</div><div class="line">--http-scgi-temp-path=/var/temp/nginx/scgi</div></pre></td></tr></table></figure>
<p>执行完成之后看到生成了<code>configure</code>文件</p>
<p><strong>编译安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">make</div><div class="line">make install</div><div class="line"># 查看安装目录</div><div class="line">cd /usr/local/application/nginx</div><div class="line">ll</div></pre></td></tr></table></figure>
<hr>
<h4 id="启动-运行"><a href="#启动-运行" class="headerlink" title="启动 运行"></a>启动 运行</h4><p>运行前需要先在var下创建好相应的临时目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir /var/temp/nginx/client -p</div><div class="line">./sbin/nginx</div><div class="line"># 查看启动的进程 master是主进程 另外一个是工作进程</div><div class="line">ps aux |grep nginx</div></pre></td></tr></table></figure>
<p>启动成功之后默认监听80端口可以用ip直接查看</p>
<p><strong>停止</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 此方式相当于先查出nginx进程id再使用kill命令强制杀掉进程。</div><div class="line">./nginx -s stop</div><div class="line"># 此方式停止步骤是待nginx进程处理任务完毕进行停止。</div><div class="line">./nginx -s quit</div></pre></td></tr></table></figure>
<p><strong>重启</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 对nginx进行重启相当于先停止nginx再启动nginx，即先执行停止命令再执行启动命令。</div><div class="line">./nginx -s quit</div><div class="line">./nginx</div><div class="line"># 重新加载配置文件：当nginx的配置文件nginx.conf修改后，要想让配置生效需要重启nginx，</div><div class="line"># 使用-s reload不用先停止nginx再启动nginx即可将配置信息在nginx中生效</div><div class="line">./nginx -s reload</div></pre></td></tr></table></figure>
<hr>
<h4 id="通过端口区分虚拟机"><a href="#通过端口区分虚拟机" class="headerlink" title="通过端口区分虚拟机"></a>通过端口区分虚拟机</h4><p>修改conf目录下面的nginx.conf.一个server就是一个虚拟主机，添加一个server修改端口号和对应的root目录。</p>
<p>修改完成之后reload配置，此时可以使用ip和端口号进行访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line">    sendfile        on;</div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        &#125;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       81;</div><div class="line">        server_name  localhost;</div><div class="line">        location / &#123;</div><div class="line">            root   html81;</div><div class="line">            index  index.html index.htm;</div><div class="line">        &#125;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html81;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h4 id="通过域名区分虚拟主机"><a href="#通过域名区分虚拟主机" class="headerlink" title="通过域名区分虚拟主机"></a>通过域名区分虚拟主机</h4><p>需要修改hosts文件来实现域名的绑定，使用hosts文件修改工具。</p>
<blockquote>
<p> 链接: <a href="https://pan.baidu.com/s/1mibwvpe" target="_blank" rel="external">https://pan.baidu.com/s/1mibwvpe</a> 密码: vmva</p>
</blockquote>
<p>a 修改hosts文件，添加如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">192.168.80.128 www.test.com</div><div class="line">192.168.80.128 www.abc.com</div></pre></td></tr></table></figure>
<p>b 修改nginx.conf，添加两个server.修改其server_name为hosts中添加的域名</p>
<p>首先监听的是80端口，另外需要修改root目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  www.test.com;</div><div class="line"></div><div class="line">    #charset koi8-r;</div><div class="line"></div><div class="line">    #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        root   html_test;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  www.abc.com;</div><div class="line"></div><div class="line">    #charset koi8-r;</div><div class="line"></div><div class="line">    #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        root   html_abc;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>c 添加相应的html目录并reload一下配置</p>
<p>此时再访问<code>www.abc.com</code> 和 <code>www.test.com</code> 就定向到了nginx的两个虚拟主机</p>
<hr>
<h4 id="实现反向代理"><a href="#实现反向代理" class="headerlink" title="实现反向代理"></a>实现反向代理</h4><p>正向代理指的是代理客户端的请求。而反向代理指的是代理服务器端，由于一个外网ip只能绑定到一台服务器上，通过反射代理机制就可以实现对多个服务进行访问，nginx实现对这多个服务的代理。</p>
<p>此种方式和上面的域名区分虚拟主机类似，不同的是提供的服务不再是静态html文件，可以在一个可用的tomcat服务。</p>
<p>a 配置hosts文件添加如下的域名映射</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">192.168.80.128 www.baiduhaha.com</div><div class="line">192.168.80.128 www.taobaohaha.com</div></pre></td></tr></table></figure>
<p>b 修改nginx.conf，添加两个server</p>
<p>注意location中不再是root节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">   upstream tomcat1 &#123;</div><div class="line">server 192.168.80.128:7080;</div><div class="line">   &#125;</div><div class="line">   server &#123;</div><div class="line">       listen       80;</div><div class="line">       server_name  www.baiduhaha.com;</div><div class="line"></div><div class="line">       #charset koi8-r;</div><div class="line"></div><div class="line">       #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">       location / &#123;</div><div class="line">           proxy_pass   http://tomcat1;</div><div class="line">           index  index.html index.htm;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   upstream tomcat2 &#123;</div><div class="line">server 192.168.80.128:7081;</div><div class="line">   &#125;</div><div class="line">   server &#123;</div><div class="line">       listen       80;</div><div class="line">       server_name  www.taobaohaha.com;</div><div class="line"></div><div class="line">       #charset koi8-r;</div><div class="line"></div><div class="line">       #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">       location / &#123;</div><div class="line">           proxy_pass   http://tomcat2;</div><div class="line">           index  index.html index.htm;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>c 在服务器上面启动两个tomcat服务，端口号分别为7080和7081 reload一下nginx的服务</p>
<p>访问<code>www.baiduhaha.com</code>即显示7080tomcat主页</p>
<p>访问<code>www.taobaohaha.com</code>即显示7081tomcat主页</p>
<hr>
<h4 id="实现负载均衡"><a href="#实现负载均衡" class="headerlink" title="实现负载均衡"></a>实现负载均衡</h4><p>假设我们的<code>www.taobaohaha.com</code>现在需要由多台机器提供服务，那就需要在upstream中配置多个server。默认不设置weight时是平均分配，设置了之后会按设置的权限对请求进行分流。模拟此效果需要再复制生成个tomcat服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   upstream tomcat2 &#123;</div><div class="line">server 192.168.80.128:7081 weight=3;</div><div class="line">server 192.168.80.128:7082 weight=1;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   server &#123;</div><div class="line">       listen       80;</div><div class="line">       server_name  www.taobaohaha.com;</div><div class="line"></div><div class="line">       #charset koi8-r;</div><div class="line"></div><div class="line">       #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">       location / &#123;</div><div class="line">           proxy_pass   http://tomcat2;</div><div class="line">           index  index.html index.htm;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/28/linux/nginx环境搭建/" data-id="cj9zcpp8s0013ishqb9emipjq" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-csharp/ashx获取post的json" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/28/csharp/ashx获取post的json/">ashx获取post的json</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/28/csharp/ashx获取post的json/">
            <time datetime="2017-09-28T02:21:30.691Z" itemprop="datePublished">2017-09-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/c/">c#</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/ashx/">ashx</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>json请求数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="attr">"tianyantag"</span>: <span class="string">"common"</span>,</div><div class="line">	<span class="attr">"mytoken"</span>: <span class="string">"123456"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ashx代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">public class WeixinToken : IHttpHandler</div><div class="line">    &#123;</div><div class="line"></div><div class="line">        public void ProcessRequest(HttpContext context)</div><div class="line">        &#123;</div><div class="line">        	// 流转json字符串</div><div class="line">            String postJson = ReadRequestData(context.Request.InputStream);</div><div class="line">            JObject jObject = JObject.Parse(postJson);</div><div class="line">            // 取json中的值</div><div class="line">            String tianyantag = jObject[&quot;tianyantag&quot;].ToString();</div><div class="line">            String mytoken = jObject[&quot;mytoken&quot;].ToString();</div><div class="line">            // 序列化</div><div class="line">            String json = JsonConvert.SerializeObject(new &#123; Code = 0, Message = &quot;请求token错误&quot;, Token = &quot;&quot;&#125;);</div><div class="line">            // 输出响应信息</div><div class="line">            WriteBack(json);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		/// &lt;summary&gt;</div><div class="line">        /// 获取请求的json字符串</div><div class="line">        /// &lt;/summary&gt;</div><div class="line">        /// &lt;param name=&quot;requestStream&quot;&gt;&lt;/param&gt;</div><div class="line">        /// &lt;returns&gt;&lt;/returns&gt;</div><div class="line">        public string ReadRequestData(Stream requestStream)</div><div class="line">        &#123;</div><div class="line">            using (Stream stream = requestStream)</div><div class="line">            &#123;</div><div class="line">                try</div><div class="line">                &#123;</div><div class="line">                    using (StreamReader strReader = new StreamReader(stream))</div><div class="line">                    &#123;</div><div class="line">                        return strReader.ReadToEnd();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                catch (Exception ex)</div><div class="line">                &#123;</div><div class="line">                    return string.Empty;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">        public bool IsReusable</div><div class="line">        &#123;</div><div class="line">            get</div><div class="line">            &#123;</div><div class="line">                return false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        private void WriteBack(String backStr)</div><div class="line">        &#123;</div><div class="line">            HttpContext.Current.Response.ContentType = &quot;text/plain&quot;;</div><div class="line">            HttpContext.Current.Response.ContentEncoding = Encoding.UTF8;</div><div class="line">            HttpContext.Current.Response.Clear();</div><div class="line">            HttpContext.Current.Response.Write(backStr);</div><div class="line">            HttpContext.Current.ApplicationInstance.CompleteRequest();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/28/csharp/ashx获取post的json/" data-id="cj9zcpp8j000oishqd77etbk4" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-linux/activeMq环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/25/linux/activeMq环境搭建/">ActiveMq环境搭建</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/25/linux/activeMq环境搭建/">
            <time datetime="2017-09-25T01:13:47.355Z" itemprop="datePublished">2017-09-25</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/linux/">linux</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>, <a class="tag-link" href="/tags/linux/">linux</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h3><p>activemq运行需要有jdk环境。如果环境中安装的是jdk1.8则需要安装5.15.0及以上版本，因为从此版本开始是基于1.8进行编译的。如果使用低版本mq服务器页面显示可能会有问题。</p>
<blockquote>
<p> 5.15.0版本 链接: <a href="https://pan.baidu.com/s/1o8brZBG" target="_blank" rel="external">https://pan.baidu.com/s/1o8brZBG</a> 密码: 7juz</p>
</blockquote>
<p>a 解压压缩包到指定的目录。使用<code>./activemq start</code>启动服务。</p>
<p>b 服务启动后可以进行管理后台，链接为<code>http://ip:8161/admin</code>.登录的用户名和密码都是admin</p>
<p>c 如果在管理后台访问时遇到503错误，需要修改hosts文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 查看机器名</div><div class="line">cat /etc/sysconfig/network</div><div class="line"># 将机器添加到hosts文件中</div><div class="line">vim /etc/hosts</div><div class="line">localhost localhost.localdomain localhost4 localhost4.localdomain4 myCentos</div><div class="line"># 重启服务</div><div class="line">./activemq restart</div></pre></td></tr></table></figure>
<hr>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p>由于一些版本的jar中包含有spring中的类，容易导致在引用和加载容器的时候发生冲突问题难以被排查。建议使用此5.11.2版本的jar包</p>
<p>引用jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试类，主要测试queue（点对点）和topic（广播）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> javax.jms.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActiveMq</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 发送queue</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueueProducer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//1.创建一个连接工厂对象ConnectionFactory对象。需要指定mq服务的ip及端口</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.88.129:61616"</span>);</div><div class="line">        <span class="comment">//2.使用ConnectionFactory创建一个连接Connection对象</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line">        <span class="comment">//3.开启连接。调用Connection对象的start方法</span></div><div class="line">        connection.start();</div><div class="line">        <span class="comment">//4.使用Connection对象创建一个Session对象</span></div><div class="line">        <span class="comment">//第一个参数是是否开启事务，一般不使用事务。保证数据的最终一致，可以使用消息队列实现。</span></div><div class="line">        <span class="comment">//如果第一个参数为true，第二个参数自动忽略。如果不开启事务false，第二个参数为消息的应答模式。一般自动应答就可以。</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line">        <span class="comment">//5.使用Session对象创建一个Destination对象，两种形式queue、topic。现在应该使用queue</span></div><div class="line">        <span class="comment">//参数就是消息队列的名称</span></div><div class="line">        Queue queue = session.createQueue(<span class="string">"test-queue"</span>);</div><div class="line">        <span class="comment">//6.使用Session对象创建一个Producer对象</span></div><div class="line">        MessageProducer producer = session.createProducer(queue);</div><div class="line">        <span class="comment">//7.创建一个TextMessage对象</span></div><div class="line">        <span class="comment">//TextMessage textMessage = new ActiveMQTextMessage();</span></div><div class="line">        <span class="comment">//textMessage.setText("hello activeMq");</span></div><div class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">"hello activeMq"</span>);</div><div class="line">        <span class="comment">//8.发送消息</span></div><div class="line">        producer.send(textMessage);</div><div class="line">        <span class="comment">//9.关闭资源</span></div><div class="line">        producer.close();</div><div class="line">        session.close();</div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 接收queue</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueueConsumer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//1.创建一个连接工厂对象ConnectionFactory对象。需要指定mq服务的ip及端口</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.88.129:61616"</span>);</div><div class="line">        <span class="comment">//2.使用ConnectionFactory创建一个连接Connection对象</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line">        <span class="comment">//3.开启连接。调用Connection对象的start方法</span></div><div class="line">        connection.start();</div><div class="line">        <span class="comment">//4.使用Connection对象创建一个Session对象</span></div><div class="line">        <span class="comment">//第一个参数是是否开启事务，一般不使用事务。保证数据的最终一致，可以使用消息队列实现。</span></div><div class="line">        <span class="comment">//如果第一个参数为true，第二个参数自动忽略。如果不开启事务false，第二个参数为消息的应答模式。一般自动应答就可以。</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line">        <span class="comment">//5.使用Session对象创建一个Destination对象，两种形式queue、topic。现在应该使用queue</span></div><div class="line">        <span class="comment">//参数就是消息队列的名称</span></div><div class="line">        Queue queue = session.createQueue(<span class="string">"test-queue"</span>);</div><div class="line">        <span class="comment">//6.使用Session创建一个Consumer对象</span></div><div class="line">        MessageConsumer consumer = session.createConsumer(queue);</div><div class="line">        <span class="comment">//7.向Consumer对象中设置一个MessageListener对象，用来接收消息</span></div><div class="line">        consumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (message <span class="keyword">instanceof</span> TextMessage) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        System.out.println(((TextMessage) message).getText());</div><div class="line">                    &#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">// 系统等待消息</span></div><div class="line">        <span class="comment">//while (true) &#123;</span></div><div class="line">        <span class="comment">//    Thread.sleep(100);</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">        System.in.read();</div><div class="line">        <span class="comment">// 关闭资源</span></div><div class="line">        consumer.close();</div><div class="line">        session.close();</div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 发送topic</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTopicProducer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//1.创建一个连接工厂对象ConnectionFactory对象。需要指定mq服务的ip及端口</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.88.129:61616"</span>);</div><div class="line">        <span class="comment">//2.使用ConnectionFactory创建一个连接Connection对象</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line">        <span class="comment">//3.开启连接。调用Connection对象的start方法</span></div><div class="line">        connection.start();</div><div class="line">        <span class="comment">//4.使用Connection对象创建一个Session对象</span></div><div class="line">        <span class="comment">//第一个参数是是否开启事务，一般不使用事务。保证数据的最终一致，可以使用消息队列实现。</span></div><div class="line">        <span class="comment">//如果第一个参数为true，第二个参数自动忽略。如果不开启事务false，第二个参数为消息的应答模式。一般自动应答就可以。</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line">        <span class="comment">//5.使用Session对象创建一个Destination对象，两种形式queue、topic。现在应该使用queue</span></div><div class="line">        <span class="comment">//参数就是消息队列的名称</span></div><div class="line">        Topic topic = session.createTopic(<span class="string">"test-topic"</span>);</div><div class="line">        <span class="comment">//6.使用Session对象创建一个Producer对象</span></div><div class="line">        MessageProducer producer = session.createProducer(topic);</div><div class="line">        <span class="comment">//7.创建一个TextMessage对象</span></div><div class="line">        <span class="comment">//TextMessage textMessage = new ActiveMQTextMessage();</span></div><div class="line">        <span class="comment">//textMessage.setText("hello activeMq");</span></div><div class="line">        TextMessage textMessage = session.createTextMessage(<span class="string">"topic activeMqaaa"</span>);</div><div class="line">        <span class="comment">//8.发送消息</span></div><div class="line">        producer.send(textMessage);</div><div class="line">        <span class="comment">//9.关闭资源</span></div><div class="line">        producer.close();</div><div class="line">        session.close();</div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 接收topic</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTopicConsumer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//1.创建一个连接工厂对象ConnectionFactory对象。需要指定mq服务的ip及端口</span></div><div class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.88.129:61616"</span>);</div><div class="line">        <span class="comment">//2.使用ConnectionFactory创建一个连接Connection对象</span></div><div class="line">        Connection connection = connectionFactory.createConnection();</div><div class="line">        <span class="comment">//3.开启连接。调用Connection对象的start方法</span></div><div class="line">        connection.start();</div><div class="line">        <span class="comment">//4.使用Connection对象创建一个Session对象</span></div><div class="line">        <span class="comment">//第一个参数是是否开启事务，一般不使用事务。保证数据的最终一致，可以使用消息队列实现。</span></div><div class="line">        <span class="comment">//如果第一个参数为true，第二个参数自动忽略。如果不开启事务false，第二个参数为消息的应答模式。一般自动应答就可以。</span></div><div class="line">        Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</div><div class="line">        <span class="comment">//5.使用Session对象创建一个Destination对象，两种形式queue、topic。现在应该使用queue</span></div><div class="line">        <span class="comment">//参数就是消息队列的名称</span></div><div class="line">        Topic topic = session.createTopic(<span class="string">"test-topic"</span>);</div><div class="line">        <span class="comment">//6.使用Session创建一个Consumer对象</span></div><div class="line">        MessageConsumer consumer = session.createConsumer(topic);</div><div class="line">        <span class="comment">//7.向Consumer对象中设置一个MessageListener对象，用来接收消息</span></div><div class="line">        consumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (message <span class="keyword">instanceof</span> TextMessage) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        System.out.println(((TextMessage) message).getText());</div><div class="line">                    &#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">// 系统等待消息</span></div><div class="line">        <span class="comment">//while (true) &#123;</span></div><div class="line">        <span class="comment">//    Thread.sleep(100);</span></div><div class="line">        <span class="comment">//&#125;</span></div><div class="line">        System.out.println(<span class="string">"topic consumer3"</span>);</div><div class="line">        System.in.read();</div><div class="line">        <span class="comment">// 关闭资源</span></div><div class="line">        consumer.close();</div><div class="line">        session.close();</div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="整合spring"><a href="#整合spring" class="headerlink" title="整合spring"></a>整合spring</h3><p><a href="http://www.cnblogs.com/dennisit/p/4552686.html" target="_blank" rel="external">topic模式实例</a></p>
<h4 id="生产者配置"><a href="#生产者配置" class="headerlink" title="生产者配置"></a>生产者配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd</span></div><div class="line">	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd</div><div class="line">	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd</div><div class="line">	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.2.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- jsm服务厂商提供的ConnectionFactory --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span> <span class="attr">id</span>=<span class="string">"mqConnectionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span> <span class="attr">value</span>=<span class="string">"tcp://192.168.80.128:61616"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- spring对ConnectionFactory的封装 --&gt;</span></div><div class="line">    <span class="comment">&lt;!--&lt;bean class="org.springframework.jms.connection.SingleConnectionFactory" id="connectionFactory"&gt;--&gt;</span></div><div class="line">        <span class="comment">&lt;!--&lt;property name="targetConnectionFactory" ref="mqConnectionFactory"/&gt;--&gt;</span></div><div class="line">    <span class="comment">&lt;!--&lt;/bean&gt;--&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置JmsTemplate --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"mqConnectionFactory"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置消息的destination对象 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span> <span class="attr">id</span>=<span class="string">"test-queue"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"test-queue"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span> <span class="attr">id</span>=<span class="string">"test-topic"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"test-topic"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span> <span class="attr">id</span>=<span class="string">"itemAddtopic"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"item-add-topic"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="消费者配置"><a href="#消费者配置" class="headerlink" title="消费者配置"></a>消费者配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd</span></div><div class="line">	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd</div><div class="line">	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd</div><div class="line">	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.2.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- jsm服务厂商提供的ConnectionFactory --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span> <span class="attr">id</span>=<span class="string">"mqConnectionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span> <span class="attr">value</span>=<span class="string">"tcp://192.168.80.128:61616"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- spring对ConnectionFactory的封装 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.connection.SingleConnectionFactory"</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetConnectionFactory"</span> <span class="attr">ref</span>=<span class="string">"mqConnectionFactory"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置消息的destination对象 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span> <span class="attr">id</span>=<span class="string">"test-queue"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"test-queue"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span> <span class="attr">id</span>=<span class="string">"test-topic"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"test-topic"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span> <span class="attr">id</span>=<span class="string">"itemAddtopic"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"item-add-topic"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置消息的接收者 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.taotao.activemq.listener.MyMessageListener"</span> <span class="attr">id</span>=<span class="string">"myMessageListener"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!--&lt;property name="connectionFactory" ref="connectionFactory"/&gt;--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"mqConnectionFactory"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"destination"</span> <span class="attr">ref</span>=<span class="string">"test-queue"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageListener"</span> <span class="attr">ref</span>=<span class="string">"myMessageListener"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 同步索引库 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.taotao.activemq.listener.ItemAddMessageListener"</span> <span class="attr">id</span>=<span class="string">"itemAddMessageListener"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!--&lt;property name="connectionFactory" ref="connectionFactory"/&gt;--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"mqConnectionFactory"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"destination"</span> <span class="attr">ref</span>=<span class="string">"itemAddtopic"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageListener"</span> <span class="attr">ref</span>=<span class="string">"itemAddMessageListener"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="junit测试"><a href="#junit测试" class="headerlink" title="junit测试"></a>junit测试</h4><p>添加消息监听者 MyMessageListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.jms.Message;</div><div class="line"><span class="keyword">import</span> javax.jms.MessageListener;</div><div class="line"><span class="keyword">import</span> javax.jms.TextMessage;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 接收消息测试</div><div class="line"> * Created on 2017/9/25.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            TextMessage textMessage = (TextMessage) message;</div><div class="line">            String text = textMessage.getText();</div><div class="line">            System.out.println(text);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试类，消费者只要开启就会一直监听是否有消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsTemplate;</div><div class="line"><span class="keyword">import</span> org.springframework.jms.core.MessageCreator;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.jms.*;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 整合spring</div><div class="line"> * Created on 2017/9/25.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActiveMqSpring</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 生产者</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJmsTemplate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"classpath:spring/applicationContext-activemq.xml"</span>);</div><div class="line">        JmsTemplate jmsTemplate = applicationContext.getBean(JmsTemplate.class);</div><div class="line">        <span class="comment">// 获取destination对象</span></div><div class="line">        Destination destination = (Destination) applicationContext.getBean(<span class="string">"test-queue"</span>);</div><div class="line">        <span class="comment">// send</span></div><div class="line">        jmsTemplate.send(destination, <span class="keyword">new</span> MessageCreator() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line">                TextMessage textMessage = session.createTextMessage(<span class="string">"spring activemq send queue message3"</span>);</div><div class="line">                <span class="keyword">return</span> textMessage;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 消费者</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJmsTemplateConsumer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"classpath:spring/applicationContext-activemq-receiver.xml"</span>);</div><div class="line">        System.in.read();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="商品添加时同步索引库"><a href="#商品添加时同步索引库" class="headerlink" title="商品添加时同步索引库"></a>商品添加时同步索引库</h4><p>添加消息监听者 ItemAddMessageListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.taotao.common.pojo.SearchItem;</div><div class="line"><span class="keyword">import</span> com.taotao.search.mapper.SearchItemMapper;</div><div class="line"><span class="keyword">import</span> org.apache.solr.client.solrj.SolrServer;</div><div class="line"><span class="keyword">import</span> org.apache.solr.common.SolrInputDocument;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.jms.Message;</div><div class="line"><span class="keyword">import</span> javax.jms.MessageListener;</div><div class="line"><span class="keyword">import</span> javax.jms.TextMessage;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 监听商品添加事件,接收到消息的处理</div><div class="line"> * Created on 2017/9/25.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemAddMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> SearchItemMapper searchItemMapper;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> SolrServer solrServer;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 取商品id</span></div><div class="line">            TextMessage textMessage = (TextMessage) message;</div><div class="line">            String text = textMessage.getText();</div><div class="line">            <span class="keyword">long</span> itemId = Long.valueOf(text);</div><div class="line">            <span class="comment">//根据商品id查询数据，取商品信息</span></div><div class="line">            <span class="comment">//等待事务提交 或者把消息发送放在表现层</span></div><div class="line">            Thread.sleep(<span class="number">1000</span>);</div><div class="line">            SearchItem searchItem = searchItemMapper.getItemById(itemId);</div><div class="line">            SolrInputDocument document = <span class="keyword">new</span> SolrInputDocument();</div><div class="line">            <span class="comment">// 操作文档</span></div><div class="line">            document.addField(<span class="string">"id"</span>, searchItem.getId());</div><div class="line">            document.addField(<span class="string">"item_title"</span>, searchItem.getTitle());</div><div class="line">            document.addField(<span class="string">"item_sell_point"</span>, searchItem.getSell_point());</div><div class="line">            document.addField(<span class="string">"item_price"</span>, searchItem.getPrice());</div><div class="line">            document.addField(<span class="string">"item_image"</span>, searchItem.getImage());</div><div class="line">            document.addField(<span class="string">"item_category_name"</span>, searchItem.getCategory_name());</div><div class="line">            document.addField(<span class="string">"item_desc"</span>, searchItem.getItem_desc());</div><div class="line">            solrServer.add(document);</div><div class="line">            solrServer.commit();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>添加商品时发送消息，部分代码展示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> JmsTemplate jmsTemplate;</div><div class="line"><span class="meta">@Resource</span>(name = <span class="string">"itemAddtopic"</span>)</div><div class="line"><span class="keyword">private</span> javax.jms.Destination destination;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> TaotaoResult <span class="title">addItem</span><span class="params">(TbItem item, String desc)</span> </span>&#123;</div><div class="line">  <span class="comment">// 生成商品id</span></div><div class="line">  Long itemId = IDUtils.genItemId();</div><div class="line">	...</div><div class="line">  <span class="comment">// 插入到商品表</span></div><div class="line">  tbItemMapper.insert(item);</div><div class="line">  <span class="comment">// 插入到商品描述表</span></div><div class="line">	...</div><div class="line">  tbItemDescMapper.insert(tbItemDesc);</div><div class="line"></div><div class="line">  <span class="comment">// 向activemq发送商品添加信息</span></div><div class="line">  jmsTemplate.send(destination, <span class="keyword">new</span> MessageCreator() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line">      TextMessage message = session.createTextMessage(itemId.toString());</div><div class="line">      <span class="keyword">return</span> message;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> TaotaoResult.ok();</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/25/linux/activeMq环境搭建/" data-id="cj9zcpp8n000vishqbtwvyhnc" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-linux/solr环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/21/linux/solr环境搭建/">solr环境搭建</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/21/linux/solr环境搭建/">
            <time datetime="2017-09-21T05:41:45.153Z" itemprop="datePublished">2017-09-21</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/linux/">linux</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/linux/">linux</a>, <a class="tag-link" href="/tags/solr/">solr</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>solr的运行必须要有jdk环境</p>
<p>单机版</p>
<p>如果发现zookeeper启动不了，可以先删除data目录下的zookeeper_server.pid文件</p>
<p>集群版</p>
<p>为了实现高可用至少需要7台服务器。</p>
<p>使用zookeeper进行分布式管理。由于zookeeper的投票选举机制，所以至少需要有三台zookeeper服务器。</p>
<p>一个collection至少分为两个分片，每个分片至少需要一个主（master）一个从（salve），所以至少需要四台tomcat服务器</p>
<p>zookeeper 集群搭建</p>
<p>a. 复制压缩包到服务器</p>
<p>b. 解压缩</p>
<p>c. 复制解压之后的目录到安装位置，复制三份（或者仅复制一份处理完之后再根据它进行复制）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar -zxvf zookeeper-3.4.6.tar.gz </div><div class="line">mkdir /usr/local/application/solr/zookeeper</div><div class="line">mv zookeeper-3.4.6 /usr/local/application/solr/solrcloud/zookeeper01</div></pre></td></tr></table></figure>
<p>d. 创建data目录，并在目录下面建myid文件，向其中写入实例的id。如1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo 1&gt;myid</div></pre></td></tr></table></figure>
<p>e. 修改配置文件。把conf目录下面的zoo_sample.cfg重命名为zoo.cfg，并修改data路径，端口号以及添加各个节点的端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mv zoo_sample.cfg zoo.cfg</div><div class="line"># 修改dataDir</div><div class="line">dataDir=/usr/local/application/solr/zookeeper/zookeeper01/data</div><div class="line"># 修改clientport，第一个可以保持2181不变</div><div class="line"># 底部添加各个节点的内部通讯端口和投票选举端口都不能重复</div><div class="line">server.1=192.168.80.128:2881:3881</div><div class="line">server.2=192.168.80.128:2882:3882</div><div class="line">server.3=192.168.80.128:2883:3883</div></pre></td></tr></table></figure>
<img title="solr1" alt="solr1" src="http://oo0vldwkt.bkt.clouddn.com/static/images/linux\solr1.png">
<p>f. 复制zookeeper01为02和03，并按上面的方法修改02和03目录内的信息，主要是data目录和端口号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp -r zookeeper01/ zookeeper02</div><div class="line">cp -r zookeeper01/ zookeeper03</div></pre></td></tr></table></figure>
<p>g. 创建启动和关闭的shell脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">vim startup.sh</div><div class="line">chmod u+x startup.sh </div><div class="line">./zookeeper01/bin/zkServer.sh start</div><div class="line">./zookeeper02/bin/zkServer.sh start</div><div class="line">./zookeeper03/bin/zkServer.sh start</div><div class="line">vim shutdown.sh</div><div class="line">chmod u+x shutdown.sh </div><div class="line">./zookeeper01/bin/zkServer.sh stop</div><div class="line">./zookeeper02/bin/zkServer.sh stop</div><div class="line">./zookeeper03/bin/zkServer.sh stop</div></pre></td></tr></table></figure>
<p>最终启动后的效果是只有一个leader其它都是follower，可以通过zkServer.sh status查看单个节点的状态</p>
<p>solr集群</p>
<p>a. 复制单机版本solr的tomcat四份，修改其端口号。四个tomcat的端口号不同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp -r tomcat-solr/ solrcloud/tomcat-solr01</div><div class="line">cp -r tomcat-solr/ solrcloud/tomcat-solr02</div><div class="line">cp -r tomcat-solr/ solrcloud/tomcat-solr03</div><div class="line">cp -r tomcat-solr/ solrcloud/tomcat-solr04</div></pre></td></tr></table></figure>
<p>b. 复制四个solrhome出来，对应到各个solr实例。原始的solrhome以是solr解压后的的solr-4.10.3/example/solr目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cp -r solr /usr/local/application/solr/solrcloud/solrhome01</div><div class="line">cp -r solr /usr/local/application/solr/solrcloud/solrhome02</div><div class="line">cp -r solr /usr/local/application/solr/solrcloud/solrhome03</div><div class="line">cp -r solr /usr/local/application/solr/solrcloud/solrhome04</div><div class="line"># 修改solr实例对应的solrhome</div><div class="line">vim tomcat-solr01/webapps/solr/WEB-INF/web.xml </div><div class="line">vim tomcat-solr02/webapps/solr/WEB-INF/web.xml </div><div class="line">vim tomcat-solr03/webapps/solr/WEB-INF/web.xml </div><div class="line">vim tomcat-solr04/webapps/solr/WEB-INF/web.xml</div></pre></td></tr></table></figure>
<p>c. 修改solrhome下面的solr.xml，配置tomcat的ip和端口号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim solrhome01/solr.xml</div><div class="line">vim solrhome02/solr.xml</div><div class="line">vim solrhome03/solr.xml</div><div class="line">vim solrhome04/solr.xml</div></pre></td></tr></table></figure>
<p>d. 让zookeeper统一管理配置文件。需要把solrhome/collection1/conf目录上传到zookeeper。上传任意的solrhome中的配置文件即可。</p>
<p>使用工具上传配置文件：solr-4.10.3/example/scripts/cloud-scripts/zkcli.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">./zkcli.sh -zkhost 192.168.80.128:2184,192.168.80.128:2182,192.168.80.128:2183 -cmd upconfig -confdir /usr/local/application/solr/solrcloud/solrhome01/collection1/conf -confname myconf</div><div class="line"># 查看上传之后的配置，使用zookeeper目录下面的bin/zkCli.sh命令</div><div class="line"># 如果连接的端口号非2181需要使用 ./zkCli.sh -server 192.168.25.154:2182</div><div class="line">ls /</div><div class="line">ls /configs</div><div class="line">ls /configs/myconf</div></pre></td></tr></table></figure>
<p>e. 修改每个tomcat/bin目录下的catalina.sh 文件，关联solr和zookeeper。修改JAVA_OPTS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JAVA_OPTS=&quot;-DzkHost=192.168.80.128:2184,192.168.80.128:2182,192.168.80.128:2183&quot;</div></pre></td></tr></table></figure>
<p>f. 访问solr实例 <a href="http://192.168.80.128:8280/solr/" target="_blank" rel="external">http://192.168.80.128:8280/solr/</a></p>
<img title="solr2" alt="solr2" src="http://oo0vldwkt.bkt.clouddn.com/static/images/linux\solr2.png">
<p>g. 创建新的collection并进行分片处理</p>
<p><a href="http://192.168.80.128:8180/solr/admin/collections?action=CREATE&amp;name=collection2&amp;numShards=2&amp;replicationFactor=2" target="_blank" rel="external">http://192.168.80.128:8180/solr/admin/collections?action=CREATE&amp;name=collection2&amp;numShards=2&amp;replicationFactor=2</a></p>
<img title="solr3" alt="solr3" src="http://oo0vldwkt.bkt.clouddn.com/static/images/linux\solr3.png">
<p>h. 删除不用的collection</p>
<p><a href="http://192.168.80.128:8180/solr/admin/collections?action=DELETE&amp;name=collection1" target="_blank" rel="external">http://192.168.80.128:8180/solr/admin/collections?action=DELETE&amp;name=collection1</a></p>
<img title="solr4" alt="solr4" src="http://oo0vldwkt.bkt.clouddn.com/static/images/linux\solr4.png">
<p>i. solr配置文件如：schema.xml的更新</p>
<p>查到的资料说是可以热更新，即不删除原来的文件直接上传即覆盖。试了几次没有成功，一直报文件已经存在。可能是因为版本的原因。所以采用的是先删除原来的文件再上传的策略。</p>
<p><a href="https://blog.liyang.io/101.html" target="_blank" rel="external">zookeeper常用命令</a>  <a href="http://www.cnblogs.com/freeweb/p/5282823.html" target="_blank" rel="external">Solr集群更新配置的方式</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 连接到zookeeper集群中的任意节点</div><div class="line">./zookeeper01/bin/zkCli.sh -server 192.168.80.128:2184</div><div class="line"># 删除schema.xml文件 myconf为配置文件目录名，可以在solr的cloud-&gt;tree中查看</div><div class="line">delete /configs/myconf/schema.xml</div><div class="line"># 上传新的配置文件，使用的是put命令 使用solr下面的工具 /example/scripts/cloud-scripts/zkcli.sh</div><div class="line"># putfile 后面第一个参数为zookeeper集群中的路径 后一个参数为要上传的文件的路径</div><div class="line">./zkcli.sh -zkhost 192.168.80.128:2184,192.168.80.128:2182,192.168.80.128:2183 -cmd putfile /configs/myconf/schema.xml /usr/local/application/solr/solrcloud/solrhome01/collection2_shard2_replica1/conf/schema.xml</div></pre></td></tr></table></figure>
<p>上传完成之后可以在ui界面中更新solr的配置文件，按钮在core admin页面。通过reload按钮即可进行更新，这样有一个麻烦的地方是需要一个一个solr打开去reload。另外一种方式是通过命令进行更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.80.128:8380/solr/admin/collections?action=RELOAD&amp;name=collection2</div></pre></td></tr></table></figure>
<hr>
<p>使用solrj管理集群</p>
<p>第一步：把solrJ相关的jar包添加到工程中。</p>
<p>第二步：创建一个SolrServer对象，需要使用CloudSolrServer子类。构造方法的参数是zookeeper的地址列表。</p>
<p>第三步：需要设置DefaultCollection属性。</p>
<p>第四步：创建一SolrInputDocument对象。</p>
<p>第五步：向文档对象中添加域</p>
<p>第六步：把文档对象写入索引库。</p>
<p>第七步：提交。</p>
<p>junit测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.solr.client.solrj.impl.CloudSolrServer;</div><div class="line"><span class="keyword">import</span> org.apache.solr.common.SolrInputDocument;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created on 2017/9/22.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSolrCloud</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSolrCloud</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        CloudSolrServer solrServer = <span class="keyword">new</span> CloudSolrServer(<span class="string">"192.168.80.128:2184,192.168.80.128:2182,192.168.80.128:2183"</span>);</div><div class="line">        solrServer.setDefaultCollection(<span class="string">"collection2"</span>);</div><div class="line">        </div><div class="line">        SolrInputDocument document = <span class="keyword">new</span> SolrInputDocument();</div><div class="line">        document.addField(<span class="string">"id"</span>, <span class="string">"test001"</span>);</div><div class="line">        document.addField(<span class="string">"item_title"</span>, <span class="string">"测试商品"</span>);</div><div class="line">        document.addField(<span class="string">"item_desc"</span>, <span class="string">"很好的东东"</span>);</div><div class="line">    </div><div class="line">        solrServer.add(document);</div><div class="line">        solrServer.commit();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>整合到spring中。在使用时使用接口去自动注入</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/21/linux/solr环境搭建/" data-id="cj9zcpp8z001eishqecyw7tze" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-java/tool/生成二维码和条形码" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/20/java/tool/生成二维码和条形码/">生成二维码和条形码</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/20/java/tool/生成二维码和条形码/">
            <time datetime="2017-09-20T06:57:38.726Z" itemprop="datePublished">2017-09-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java/">java</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/tool/">tool</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p> 使用google提供的zxing组件来生成二维码和条形码， pom文件中的依赖为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>BarCodeUtils</code>类，使用到的流转换类为之前写过的<code>ConvertIOUtil</code></p>
<p>默认生成了一个输出流，可以输出或者生成一个图片地址输出图片地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.google.zxing.BarcodeFormat;</div><div class="line"><span class="keyword">import</span> com.google.zxing.EncodeHintType;</div><div class="line"><span class="keyword">import</span> com.google.zxing.MultiFormatWriter;</div><div class="line"><span class="keyword">import</span> com.google.zxing.WriterException;</div><div class="line"><span class="keyword">import</span> com.google.zxing.client.j2se.MatrixToImageWriter;</div><div class="line"><span class="keyword">import</span> com.google.zxing.common.BitMatrix;</div><div class="line"><span class="keyword">import</span> com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;</div><div class="line"><span class="keyword">import</span> com.ly.util.ConvertIOUtil;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.nio.file.Path;</div><div class="line"><span class="keyword">import</span> java.nio.file.Paths;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 二维码,条形码生成</div><div class="line"> * Created on 2017/7/10.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BarCodeUtils</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 默认后缀名</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String default_stuffix = <span class="string">"png"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 默认编码格式</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String default_charset = <span class="string">"UTF-8"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 生成条形码</div><div class="line">     * <span class="doctag">@param</span> contents      内容</div><div class="line">     * <span class="doctag">@param</span> width         宽度</div><div class="line">     * <span class="doctag">@param</span> height        高度</div><div class="line">     * <span class="doctag">@return</span>              条形码图片地址</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createBarCode</span><span class="params">(String contents, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">int</span> codeWidth = <span class="number">3</span> + <span class="comment">// start guard    </span></div><div class="line">                (<span class="number">7</span> * <span class="number">6</span>) + <span class="comment">// left bars    </span></div><div class="line">                <span class="number">5</span> + <span class="comment">// middle guard    </span></div><div class="line">                (<span class="number">7</span> * <span class="number">6</span>) + <span class="comment">// right bars    </span></div><div class="line">                <span class="number">3</span>; <span class="comment">// end guard    </span></div><div class="line">        codeWidth = Math.max(codeWidth, width);</div><div class="line">        BitMatrix bitMatrix = <span class="keyword">new</span> MultiFormatWriter().encode(contents,</div><div class="line">                BarcodeFormat.CODE_128, codeWidth, height, <span class="keyword">null</span>);</div><div class="line">        OutputStream os = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        MatrixToImageWriter.writeToStream(bitMatrix, <span class="string">"png"</span>, os);</div><div class="line">        String image = UpYunUtil.UploadImage(ConvertIOUtil.parse(os));</div><div class="line">        <span class="keyword">return</span> image;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 生成二维码到指定文件路径</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> codeData        二维码内容</div><div class="line">     * <span class="doctag">@param</span> filePath        文件,格式为/fatherpath/childpath/filename.stuffix</div><div class="line">     * <span class="doctag">@param</span> charset         编码默认为uft-8</div><div class="line">     * <span class="doctag">@param</span> correctionLevel 错误修正级别1，2，3，4</div><div class="line">     * <span class="doctag">@param</span> height          高度</div><div class="line">     * <span class="doctag">@param</span> width           宽度</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">createQRCode2File</span><span class="params">(String codeData, String filePath, String charset, <span class="keyword">int</span> correctionLevel, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Path path = Paths.get(filePath);</div><div class="line">            String suffix = filePath.substring(filePath.lastIndexOf(<span class="string">'.'</span>) + <span class="number">1</span>);</div><div class="line">            <span class="keyword">if</span> (suffix == <span class="keyword">null</span> || <span class="string">""</span>.equals(suffix)) &#123;</div><div class="line">                suffix = default_stuffix;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (charset == <span class="keyword">null</span> || <span class="string">""</span>.equals(charset)) &#123;</div><div class="line">                charset = default_charset;</div><div class="line">            &#125;</div><div class="line">            Map&lt;EncodeHintType, Object&gt; hintMap = createHintMap(correctionLevel);</div><div class="line">            BarcodeFormat type = BarcodeFormat.QR_CODE;</div><div class="line">            BitMatrix matrix = <span class="keyword">new</span> MultiFormatWriter().encode(<span class="keyword">new</span> String(codeData.getBytes(charset), charset), type, width, height, hintMap);</div><div class="line">            MatrixToImageWriter.writeToPath(matrix, suffix, path);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 输出二维码到输出流</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> codeData        二维码内容</div><div class="line">     * <span class="doctag">@param</span> height          高度</div><div class="line">     * <span class="doctag">@param</span> width           宽度</div><div class="line">     * <span class="doctag">@param</span> charset         编码格式，默认utf-8</div><div class="line">     * <span class="doctag">@param</span> suffix          生成的文件后缀名</div><div class="line">     * <span class="doctag">@param</span> correctionLevel 错误修正级别1，2，3，4，级别越高越好识别，特别是在二维码中加入了logo的时候</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> WriterException</div><div class="line">     * <span class="doctag">@throws</span> IOException</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> OutputStream <span class="title">createQRCode2Stream</span><span class="params">(String codeData, <span class="keyword">int</span> height, <span class="keyword">int</span> width, String charset,</span></span></div><div class="line">                                                    String suffix, <span class="keyword">int</span> correctionLevel) <span class="keyword">throws</span> WriterException, IOException &#123;</div><div class="line">        <span class="keyword">if</span> (suffix == <span class="keyword">null</span> || suffix.equals(<span class="string">""</span>)) &#123;</div><div class="line">            suffix = default_stuffix;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (charset == <span class="keyword">null</span> || charset.equals(<span class="string">""</span>)) &#123;</div><div class="line">            charset = default_charset;</div><div class="line">        &#125;</div><div class="line">        Map&lt;EncodeHintType, Object&gt; hintMap = createHintMap(correctionLevel);</div><div class="line">        BarcodeFormat type = BarcodeFormat.QR_CODE;</div><div class="line">        BitMatrix matrix = <span class="keyword">new</span> MultiFormatWriter().encode(<span class="keyword">new</span> String(codeData.getBytes(charset), charset), type, width, height, hintMap);</div><div class="line">        OutputStream os = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        MatrixToImageWriter.writeToStream(matrix, suffix, os);</div><div class="line">        <span class="keyword">return</span> os;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 得到二维码图片路径</div><div class="line">     * <span class="doctag">@param</span> codeData      内容</div><div class="line">     * <span class="doctag">@param</span> height        高度</div><div class="line">     * <span class="doctag">@param</span> width         宽度</div><div class="line">     * <span class="doctag">@return</span>              生成的图片路径</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createQRCode</span><span class="params">(String codeData, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        OutputStream os = createQRCode2Stream(codeData, height, width, <span class="string">"UTF-8"</span>, <span class="string">""</span>, <span class="number">4</span>);</div><div class="line">        String image = UpYunUtil.UploadImage(ConvertIOUtil.parse(os));</div><div class="line">        <span class="keyword">return</span> image;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 参数处理，错误修正级别</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> correctionLevel</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;EncodeHintType, Object&gt; <span class="title">createHintMap</span><span class="params">(<span class="keyword">int</span> correctionLevel)</span> </span>&#123;</div><div class="line">        Map&lt;EncodeHintType, Object&gt; hintMap = <span class="keyword">new</span> HashMap&lt;EncodeHintType, Object&gt;();</div><div class="line">        hintMap.put(EncodeHintType.MARGIN, <span class="number">1</span>);<span class="comment">//空白填充</span></div><div class="line">        <span class="keyword">if</span> (correctionLevel == <span class="number">2</span>) &#123;</div><div class="line">            hintMap.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.M);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (correctionLevel == <span class="number">3</span>) &#123;</div><div class="line">            hintMap.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.Q);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (correctionLevel == <span class="number">4</span>) &#123;</div><div class="line">            hintMap.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            hintMap.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.L);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> hintMap;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/20/java/tool/生成二维码和条形码/" data-id="cj9zcppbj004xishqk5wysfrr" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-java/ssh整合" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/06/java/ssh整合/">ssh整合</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/06/java/ssh整合/">
            <time datetime="2017-09-06T06:20:40.393Z" itemprop="datePublished">2017-09-06</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java/">java</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/ssh/">ssh</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="需要的jar包"><a href="#需要的jar包" class="headerlink" title="需要的jar包"></a>需要的jar包</h3><p>整合前需要导入三个框架的jar包，如果是使用的maven管理直接配置pom.xml文件即可</p>
<h4 id="Struts2-14个jar"><a href="#Struts2-14个jar" class="headerlink" title="Struts2 14个jar"></a>Struts2 14个jar</h4><ul>
<li>struts-2.3.24\apps\struts2-blank\WEB-INF\lib*.jar     – Struts2需要的所有jar包</li>
<li>struts2-spring-plugin-2.3.24.jar                      —Struts2整合Spring的插件包，在spring中提供</li>
</ul>
<h4 id="Hibernate-20个jar"><a href="#Hibernate-20个jar" class="headerlink" title="Hibernate 20个jar"></a>Hibernate 20个jar</h4><ul>
<li>hibernate-release-5.0.7.Final\lib\required*.jar          – Hibernate框架需要的jar包</li>
<li>slf4j-api-1.6.1.jar                                        – 日志接口</li>
<li>slf4j-log4j12-1.7.2.jar                                    – 日志实现</li>
<li>mysql-connector-java-5.1.7-bin.jar                        – MySQL的驱动包</li>
</ul>
<h4 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h4><ul>
<li>IOC核心包</li>
<li>AOP核心包</li>
<li>JDBC模板和事务核心包</li>
<li>Spring整合JUnit测试包</li>
<li>Spring整合Hibernate核心包</li>
<li>Spring整合Struts2核心包</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/06/java/ssh整合/" data-id="cj9zcpp8j000pishqydy2r5ji" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-java/spring/spring-03事务管理" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/01/java/spring/spring-03事务管理/">spring-03事务管理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/01/java/spring/spring-03事务管理/">
            <time datetime="2017-09-01T08:56:34.573Z" itemprop="datePublished">2017-09-01</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java/">java</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/ssh/">ssh</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/ssh/spring/">spring</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/spring/">spring</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><p>关于事务的内容可以查看 <a href="http://xxyxpy.pub/2017/08/01/java/web/web-05%E4%BA%8B%E5%8A%A1/">web05事务</a></p>
<h3 id="Spring框架中事务相关的类和API"><a href="#Spring框架中事务相关的类和API" class="headerlink" title="Spring框架中事务相关的类和API"></a>Spring框架中事务相关的类和API</h3><h4 id="接口和API"><a href="#接口和API" class="headerlink" title="接口和API"></a>接口和API</h4><ul>
<li>PlatformTransactionManager接口 平台事务管理器，真正管理事务的类。该接口有具体的实现类，根据不同的持久层框架需要选择不同的实现类</li>
<li>TransactionDefinition接口 事务定义信息，包括事务的隔离级别、传播行为、超时以及是否只读等</li>
<li>TransactionStatus接口 事务的状态</li>
</ul>
<p>平台事务管理器是真正管理事务的对象，根据事务定义的信息进行事务管理。在管理事务中产生一些状态并将状态记录到TransactionStatus中</p>
<h4 id="PlatformTransactionManager接口中实现类和常用的方法"><a href="#PlatformTransactionManager接口中实现类和常用的方法" class="headerlink" title="PlatformTransactionManager接口中实现类和常用的方法"></a>PlatformTransactionManager接口中实现类和常用的方法</h4><h5 id="实现类"><a href="#实现类" class="headerlink" title="实现类"></a>实现类</h5><ul>
<li>如果使用的是Spring的JDBC模版或MyBatis框架需要选择DataSourceTransactionManager实现类</li>
<li>如果使用的是Hibernate框架需要选择HibernateTransactionManager实现类</li>
</ul>
<h5 id="常用方法（了解即可，一般不需要手动调用）"><a href="#常用方法（了解即可，一般不需要手动调用）" class="headerlink" title="常用方法（了解即可，一般不需要手动调用）"></a>常用方法（了解即可，一般不需要手动调用）</h5><ul>
<li>void commit(TransactionStatus status)</li>
<li>TransactionStatus getTransaction(TransactionDefinition definition)</li>
<li>void rollback(TransactionStatus status)</li>
</ul>
<h4 id="TransactionDefinition接口"><a href="#TransactionDefinition接口" class="headerlink" title="TransactionDefinition接口"></a>TransactionDefinition接口</h4><p>事务的隔离级别常量</p>
<ul>
<li>static int ISOLATION_DEFAULT                     – 采用数据库的默认隔离级别</li>
<li>static int ISOLATION_READ_UNCOMMITTED </li>
<li>static int ISOLATION_READ_COMMITTED </li>
<li>static int ISOLATION_REPEATABLE_READ </li>
<li>static int ISOLATION_SERIALIZABLE </li>
</ul>
<h4 id="事务的传播行为常量（一般不需要设置，使用默认值即可）"><a href="#事务的传播行为常量（一般不需要设置，使用默认值即可）" class="headerlink" title="事务的传播行为常量（一般不需要设置，使用默认值即可）"></a>事务的传播行为常量（一般不需要设置，使用默认值即可）</h4><p>事务的传播行为解决的是业务层之间的互相调用，确定不同业务类之间事务开启的方式</p>
<ul>
<li>PROPAGATION_REQUIRED（默认值）：A中有事务使用A中的事务，如果没有在B中就会开启一个新的事务将A包含进来以保存AB两个在同一个事务中</li>
<li>PROPAGATION_SUPPORTS：A中有事务使用A中的事务，如果没有那么B也不使用事务</li>
<li>PROPAGATION_MANDATORY：A中有事务使用A中的事务，如果没有那么拋出异常</li>
<li>PROPAGATION_REQUIRES_NEW：A中有事务将A中的事务挂起，B创建一个新的事务以保证AB两个不在同一个事务</li>
<li>PROPAGATION_NOT_SUPPORTED：A中有事务，将A中的事务挂起</li>
<li>PROPAGATION_NEVER：A中有事务，拋出异常</li>
<li>PROPAGATION_NESTED：嵌套事务，当A执行之后就会在这个位置设置一个保存点。如果B没有问题执行通过，如果B出现异常根据需求进行回滚到保存点或是初始状态</li>
</ul>
<h3 id="基于AspectJ的XML方式的事务管理"><a href="#基于AspectJ的XML方式的事务管理" class="headerlink" title="基于AspectJ的XML方式的事务管理"></a>基于AspectJ的XML方式的事务管理</h3><p>Dao层接口和实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outMoney</span><span class="params">(String out, <span class="keyword">double</span> money)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inMoney</span><span class="params">(String in, <span class="keyword">double</span> money)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDaoImpl</span> <span class="keyword">extends</span> <span class="title">JdbcDaoSupport</span> <span class="keyword">implements</span> <span class="title">AccountDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outMoney</span><span class="params">(String out, <span class="keyword">double</span> money)</span> </span>&#123;</div><div class="line">        getJdbcTemplate().update(<span class="string">"update t_account set money = money - ? where name = ?"</span>, money, out);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inMoney</span><span class="params">(String in, <span class="keyword">double</span> money)</span> </span>&#123;</div><div class="line">        <span class="comment">// int i = 10/0;</span></div><div class="line">        getJdbcTemplate().update(<span class="string">"update t_account set money = money + ? where name = ?"</span>, money, in);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Service层接口和实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pay</span><span class="params">(String out, String in, <span class="keyword">double</span> money)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> AccountDao accountDao;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountDao</span><span class="params">(AccountDao accountDao)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.accountDao = accountDao;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(String out, String in, <span class="keyword">double</span> money)</span> </span>&#123;</div><div class="line">        accountDao.outMoney(out, money);</div><div class="line">        accountDao.inMoney(in, money);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="comment">&lt;!--suppress SpringFacetInspection --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans </span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context </div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://www.springframework.org/schema/aop</div><div class="line">       http://www.springframework.org/schema/aop/spring-aop.xsd</div><div class="line">       http://www.springframework.org/schema/tx </div><div class="line">       http://www.springframework.org/schema/tx/spring-tx.xsd"&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- c3p0连接池 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> <span class="attr">id</span>=<span class="string">"dataSource"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mytest"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 注入连接池 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置事务增强 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!--propagation=REQUIRED为默认值,可以不写--&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"pay"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置aop切面 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* day3.demo1.AccountServiceImpl.pay(..))"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置dao --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"day3.demo1.AccountDaoImpl"</span> <span class="attr">id</span>=<span class="string">"accountDao"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置service --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"day3.demo1.AccountServiceImpl"</span> <span class="attr">id</span>=<span class="string">"accountService"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accountDao"</span> <span class="attr">ref</span>=<span class="string">"accountDao"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(<span class="string">"classpath:applicationContext5.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span>(name = <span class="string">"accountService"</span>)</div><div class="line">    AccountService accountService;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * spring框架的</div><div class="line">     * 声明式事务（采用XML配置文件的方式）</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">        accountService.pay(<span class="string">"王五"</span>, <span class="string">"赵六"</span>, <span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="基于AspectJ的注解方式的事务管理"><a href="#基于AspectJ的注解方式的事务管理" class="headerlink" title="基于AspectJ的注解方式的事务管理"></a>基于AspectJ的注解方式的事务管理</h3><p>Dao层不作修改</p>
<p>Servce层对impl实现类添加注解@Transactional</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> AccountDao accountDao;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountDao</span><span class="params">(AccountDao accountDao)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.accountDao = accountDao;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(String out, String in, <span class="keyword">double</span> money)</span> </span>&#123;</div><div class="line">        accountDao.outMoney(out, money);</div><div class="line">        accountDao.inMoney(in, money);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置文件修改为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="comment">&lt;!--suppress SpringFacetInspection --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans </span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context </div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://www.springframework.org/schema/aop</div><div class="line">       http://www.springframework.org/schema/aop/spring-aop.xsd</div><div class="line">       http://www.springframework.org/schema/tx </div><div class="line">       http://www.springframework.org/schema/tx/spring-tx.xsd"&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- c3p0连接池 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> <span class="attr">id</span>=<span class="string">"dataSource"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mytest"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 注入连接池 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置事务增强 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!--propagation=REQUIRED为默认值,可以不写--&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"pay"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置aop切面 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* day3.demo1.AccountServiceImpl.pay(..))"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置dao --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"day3.demo1.AccountDaoImpl"</span> <span class="attr">id</span>=<span class="string">"accountDao"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置service --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"day3.demo1.AccountServiceImpl"</span> <span class="attr">id</span>=<span class="string">"accountService"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accountDao"</span> <span class="attr">ref</span>=<span class="string">"accountDao"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试类不变，同样达到事务管理的效果</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/09/01/java/spring/spring-03事务管理/" data-id="cj9zcppas003yishq2xn6bpsy" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-java/spring/spring-02IOC和AOP" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/31/java/spring/spring-02IOC和AOP/">spring-02IOC和AOP</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/31/java/spring/spring-02IOC和AOP/">
            <time datetime="2017-08-31T05:38:10.205Z" itemprop="datePublished">2017-08-31</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java/">java</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/ssh/">ssh</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/ssh/spring/">spring</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/spring/">spring</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="IOC之注解方式"><a href="#IOC之注解方式" class="headerlink" title="IOC之注解方式"></a>IOC之注解方式</h3><p>更多注解可查看 <a href="http://blog.leanote.com/post/sheng91666@163.com/spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%B1%87%E6%80%BB" target="_blank" rel="external">spring常用注解汇总</a></p>
<p>在实际的生产环境尤其是在Spring Boot中注解方式是最常被使用的，使用注解可以摆脱繁琐的xml配置。如果要使用注解需要作如下配置：</p>
<ul>
<li><p>添加spring-aop的jar包</p>
</li>
<li><p>修改xml配置文件主要是添加约束和配置注解扫描</p>
<p>注解扫描的包名可以是相应包的父级，比如配置<code>day2</code>则此包下面所有的子包都会被扫描</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="comment">&lt;!--suppress SpringFacetInspection --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans </span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context </div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 配置注解扫描 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"day2.demo1"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>接口和实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 如果不设置值，则默认名称为小写开头的类名userServiceImp</span></div><div class="line"><span class="meta">@Service</span>(<span class="string">"userService"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"serviceImpl save..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">  ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext2.xml"</span>);</div><div class="line">  UserService userService = (UserService) applicationContext.getBean(<span class="string">"userService"</span>);</div><div class="line">  userService.save();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="框架中对于Bean管理的常用注解"><a href="#框架中对于Bean管理的常用注解" class="headerlink" title="框架中对于Bean管理的常用注解"></a>框架中对于Bean管理的常用注解</h3><h4 id="作用在类上面的注解"><a href="#作用在类上面的注解" class="headerlink" title="作用在类上面的注解"></a>作用在类上面的注解</h4><ul>
<li>@Component 组件，作用在类上面</li>
<li>@Controller 作用在Web层</li>
<li>@Service 作用在Service层</li>
<li>@Repository 作用在持久层（dao层）</li>
</ul>
<h4 id="作用在属性上面的注解，使用注解时不需要提供set方法"><a href="#作用在属性上面的注解，使用注解时不需要提供set方法" class="headerlink" title="作用在属性上面的注解，使用注解时不需要提供set方法"></a>作用在属性上面的注解，使用注解时不需要提供set方法</h4><ul>
<li>@Value 用于注入普通类型</li>
<li>@Autowired 默认按类型进行自动装配，适用于接口只有一个实现类时。如果想按名称进行注入同时使用@Qualifier指定名称</li>
<li>@Resource java提供的注解，需要指定name属性，即按名称进行注入。替代上面@Autowired和@Qualifier的情况</li>
</ul>
<h4 id="Bean的作用范围和生命周期注解"><a href="#Bean的作用范围和生命周期注解" class="headerlink" title="Bean的作用范围和生命周期注解"></a>Bean的作用范围和生命周期注解</h4><ul>
<li>@Scope 相当于xml配置时的scope属性，可以有prototype、singleton（默认）等值</li>
<li>@PostConstruct 相当于init-method</li>
<li>@PreDestroy 相当于destroy-method</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Repository</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"userDaoImpl save..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Service</span>(<span class="string">"userService"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Value</span>(<span class="string">"tom"</span>)</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">//@Resource(name = "userDaoImpl")</span></div><div class="line">    <span class="meta">@Autowired</span> <span class="comment">// 基于类型装配，如果有多个实现类需要同时使用@Qualifier</span></div><div class="line">    <span class="meta">@Qualifier</span>(<span class="string">"userDaoImpl"</span>)</div><div class="line">    <span class="keyword">private</span> UserDao userDao;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"name:"</span> + name);</div><div class="line">        userDao.save();</div><div class="line">        System.out.println(<span class="string">"serviceImpl save..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Spring整合JUnit"><a href="#Spring整合JUnit" class="headerlink" title="Spring整合JUnit"></a>Spring整合JUnit</h3><p>为了简化测试Spring框架提供了整合Junit的功能，使用此功能前需要先引入spring-test.jar，在具体的测试类上添加注解，并且可以注解注入配置文件。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(<span class="string">"classpath:applicationContext.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDemo1</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Resource</span>(name=<span class="string">"userService"</span>)</div><div class="line">  <span class="keyword">private</span> UserService userService;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo2</span><span class="params">()</span></span>&#123;</div><div class="line">    userService.save();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Spring核心功能之AOP"><a href="#Spring核心功能之AOP" class="headerlink" title="Spring核心功能之AOP"></a>Spring核心功能之AOP</h3><p>也可参考 <a href="http://blog.csdn.net/javazejian/article/details/56267036" target="_blank" rel="external">关于Spring AOP（AspectJ）你该知晓的一切</a></p>
<h4 id="AOP概述"><a href="#AOP概述" class="headerlink" title="AOP概述"></a>AOP概述</h4><ol>
<li><p>什么是AOP</p>
<ul>
<li>AOP为Aspect Oriented Programming的缩写，意为：面向切面编程</li>
<li>AOP是一种编程范式，隶属于软件工程范畴，用于指导开发者如何组织程序结构</li>
<li>AOP最早是由AOP联盟的组织提出并制定的一套规范。Spring将AOP思想引入到框架中</li>
<li>AOP是通过预编译方式和运行期间动态代理实现程序功能的统一维护的一种技术</li>
<li>利用AOP可以对业务各个部分进行隔离，从而使业务逻辑各部分之前的耦合度降低提高程序的可重用性，同时提高开发效率</li>
</ul>
</li>
<li><p>AOP特点</p>
<ul>
<li>面向切面编程思想</li>
<li>采取横向抽取机制，取代了传统纵向继承体系重复性代码。如性能监控，事务管理，日志记录等</li>
<li>可以在不修改源代码的前提下对程序的功能进行增强</li>
</ul>
</li>
<li><p>Spring框架的AOP底层实现</p>
<p>底层也是采用的动态代理技术，代理的方式有两种：</p>
<ul>
<li>基于JDK的动态代理。此方式必须要有接口和具体的实现类才可以生成代理对象</li>
<li>基于CGLIB的动态代理。对于没有实现接口的类采用此种方式，使用动态代理产生这个类的子类</li>
</ul>
</li>
</ol>
<h4 id="使用AspectJ的XML方式完成AOP的开发"><a href="#使用AspectJ的XML方式完成AOP的开发" class="headerlink" title="使用AspectJ的XML方式完成AOP的开发"></a>使用AspectJ的XML方式完成AOP的开发</h4><ul>
<li><p>引入相关的开发jar包。AOP相关的spring-aop、com.springsource.org.aopalliance，AspectJ相关的com.springsource.org.aspectj.weaver、spring-aspects</p>
</li>
<li><p>修改applicationContext.xml配置文件添加AOP相关的schema约束，修改完成之后的文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="comment">&lt;!--suppress SpringFacetInspection --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans </span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context </div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://www.springframework.org/schema/aop</div><div class="line">       http://www.springframework.org/schema/aop/spring-aop.xsd"&gt;</div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>定义接口和实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomerDao</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Repository</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerDaoImpl</span> <span class="keyword">implements</span> <span class="title">CustomerDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"impl save..."</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"impl update..."</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"impl delete..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>定义切面类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"myAspectXml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspectXml</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"log sth..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在applicationContext.xml中配置切面类和通知</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"day2.demo2"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 配置AOP --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 引入切面类 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"myAspectXml"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 定义通知类型：切面类的方法和切入点表达式 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"log"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* day2.demo2.CustomerDaoImpl.save(..))"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(<span class="string">"classpath:applicationContext3.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span>(name = <span class="string">"customerDao"</span>)</div><div class="line">    <span class="keyword">private</span> CustomerDao customerDao;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">        customerDao.save();</div><div class="line">        customerDao.delete();</div><div class="line">        customerDao.update();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<img title="001" alt="001" src="http://oo0vldwkt.bkt.clouddn.com/static/images/java\spring\001.png">
<h4 id="切入点表达式"><a href="#切入点表达式" class="headerlink" title="切入点表达式"></a>切入点表达式</h4><p>在配置切入点的时候需要定义表达式，重点的格式如下：execution(public <em> </em>(..))，定义为：execution([访问修饰符] 返回类型 包名.类名.方法名(参数))</p>
<ul>
<li>访问修改符可以省略不写，并不是必须要出现的</li>
<li>返回值类型必须出现，根据实际的返回值编写，可以用*替代，表示所有包括void</li>
<li>包名可能有一坨多个，比如com.a.b.ClassA.method。com是不可以省略的但可以用*替代，*.a.b.ClassA.method；中间的包名可以使用*替代，com.a.*.ClassA.method；省略中间的多个包名可以使用..，com..ClassA.method</li>
<li>类名也可以用 <em> 替代，还有其它类似的写法如 </em>DaoImpl 表达所有以DaoImpl结尾的</li>
<li>方法编写方法和类名相同</li>
<li>参数如果是一个的话可以用 * 号替代，当然也可以写实际的参数。如果想代表任意参数使用..，同样的也包括void</li>
</ul>
<p>在实际的使用过程中通用的切入点表达式可以写成：<code>execution(* pub.xxyxpy.service.*.*(..))</code></p>
<h4 id="AOP的通知类型"><a href="#AOP的通知类型" class="headerlink" title="AOP的通知类型"></a>AOP的通知类型</h4><ul>
<li><p>前置通知。在目标类的方法执行之前执行，可以对方法的参数来做校验</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"log"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.save*(..))"</span>/&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>后置通知。方法正常执行后的通知，可以修改方法的返回值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"afterReturn"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.update*(..))"</span>/&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>最终通知。在目标类的方法执行之后执行，如果出现异常最终通知也会执行，可以用于释放资源</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"after"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.delete*(..))"</span>/&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>异常通知。在出现异常后通知，用于包装异常的信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"except"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.updateExcept*(..))"</span>/&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>环绕通知。在方法执行前后执行，目标方法默认不执行需要在切面类的方法中使用ProceedingJoinPoint的proceed方法来让目标对象的方法执行</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">"around"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.deleteA*(..))"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>测试使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 切面类</span></div><div class="line"><span class="meta">@Component</span>(<span class="string">"myAspectXml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspectXml</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"前置通知：log sth..."</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturn</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"后置通知：方法正常执行之后的。。。"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"最终通知：目标类的方法执行之后执行"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">except</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"异常通知：出现异常之后的通知，无异常不执行"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"环绕通知前"</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            joinPoint.proceed();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">            throwable.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"环绕通知后"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 测试的实现类（接口省略）</span></div><div class="line"><span class="meta">@Repository</span>(<span class="string">"customerDao"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerDaoImpl</span> <span class="keyword">implements</span> <span class="title">CustomerDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"进 save 方法"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"进 update 方法"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateExcept</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"进 updateException 方法"</span>);</div><div class="line">        <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"进 delete 方法"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAround</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"进 deleteAround 方法"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>applicationContext配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"day2.demo2"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 配置AOP --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 引入切面类 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"myAspectXml"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 定义通知类型：切面类的方法和切入点表达式 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"log"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* day2.demo2.CustomerDaoImpl.save(..))"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 后置通知 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"afterReturn"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.update*(..))"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 最终通知 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"after"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.delete*(..))"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 异常通知 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"except"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.updateExcept*(..))"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 环绕通知 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">"around"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* *..*.*Dao.deleteA*(..))"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(<span class="string">"classpath:applicationContext3.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span>(name = <span class="string">"customerDao"</span>)</div><div class="line">    <span class="keyword">private</span> CustomerDao customerDao;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">        customerDao.save();</div><div class="line">        customerDao.delete();</div><div class="line">        customerDao.deleteAround();</div><div class="line">        customerDao.update();</div><div class="line">        customerDao.updateExcept();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<img title="002" alt="002" src="http://oo0vldwkt.bkt.clouddn.com/static/images/java\spring\002.png">
</li>
</ul>
<h4 id="使用注解的方式实现AOP"><a href="#使用注解的方式实现AOP" class="headerlink" title="使用注解的方式实现AOP"></a>使用注解的方式实现AOP</h4><p>几个通知类型的注解为：</p>
<ul>
<li>@Before 前置通知</li>
<li>@AfterReturning 后置通知</li>
<li>@Around 环绕通知</li>
<li>@After 最终通知</li>
<li>@AfterThrowing 异常通知</li>
</ul>
<p>接口和实现类不变，需要修改配置文件以及切面类。测试结果和xml的方式相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 切面类</span></div><div class="line"><span class="meta">@Component</span>(<span class="string">"myAspectXml"</span>)</div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspectXml</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* day2.demo3.CustomerDaoImpl.save(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"前置通知：log sth..."</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@AfterReturning</span>(<span class="string">"execution(* *..*.*Dao.update*(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturn</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"后置通知：方法正常执行之后的。。。"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@After</span>(<span class="string">"execution(* *..*.*Dao.delete*(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"最终通知：目标类的方法执行之后执行"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@AfterThrowing</span>(<span class="string">"execution(* *..*.*Dao.updateExcept*(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">except</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"异常通知：出现异常之后的通知，无异常不执行"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//@Around("execution(* *..*.*Dao.deleteA*(..))")</span></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"MyAspectXml.fn()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"环绕通知前"</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            joinPoint.proceed();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">            throwable.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"环绕通知后"</span>);</div><div class="line">        System.out.println(<span class="string">"============================"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 切入点</span></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(* *..*.*Dao.deleteA*(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fn</span><span class="params">()</span> </span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 复制了接口和实现类到新的包 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"day2.demo3"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 开启自动代理 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 配置AOP,注解方式不需要配置切面 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://xxyxpy.pub/2017/08/31/java/spring/spring-02IOC和AOP/" data-id="cj9zcppat0041ishqg0pac5gl" class="article-share-link"><i class="fa fa-share"></i>Compartir</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; Anterior</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Siguiente  &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">Recientes</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/22/linux/vps相关/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/linux/">linux</a></p>
                            <p class="item-title"><a href="/2017/12/22/linux/vps相关/" class="title">vps相关</a></p>
                            <p class="item-date"><time datetime="2017-12-22T07:37:19.060Z" itemprop="datePublished">2017-12-22</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/21/linux/linux/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/linux/">linux</a></p>
                            <p class="item-title"><a href="/2017/12/21/linux/linux/" class="title">linux</a></p>
                            <p class="item-date"><time datetime="2017-12-21T01:22:22.788Z" itemprop="datePublished">2017-12-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/20/linux/docker/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/linux/">linux</a></p>
                            <p class="item-title"><a href="/2017/12/20/linux/docker/" class="title">docker</a></p>
                            <p class="item-date"><time datetime="2017-12-20T01:59:03.718Z" itemprop="datePublished">2017-12-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/15/java/tool/java_other/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java/">java</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/java/tool/">tool</a></p>
                            <p class="item-title"><a href="/2017/12/15/java/tool/java_other/" class="title">java_other</a></p>
                            <p class="item-date"><time datetime="2017-12-15T10:14:54.963Z" itemprop="datePublished">2017-12-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/28/java/spring/spring boot点滴/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/spring/">spring</a></p>
                            <p class="item-title"><a href="/2017/11/28/java/spring/spring boot点滴/" class="title">spring boot点滴</a></p>
                            <p class="item-date"><time datetime="2017-11-28T09:24:59.869Z" itemprop="datePublished">2017-11-28</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">Categorias</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/">IDE</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c#</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">28</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/jdbc/">jdbc</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/ssh/">ssh</a><span class="category-list-count">14</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/ssh/hibernate/">hibernate</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/ssh/spring/">spring</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/ssh/struts2/">struts2</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/tool/">tool</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/web/">web</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/web/servlet/">servlet</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/myBlog/">myBlog</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nosql/">nosql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/激活码/">激活码</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">Archivos</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">Etiquetas</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Intellij/">Intellij</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activemq/">activemq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/annotaion/">annotaion</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ashx/">ashx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cookie/">cookie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/el/">el</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filter/">filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hiberante/">hiberante</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdbc/">jdbc</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk/">jdk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jsp/">jsp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jstl/">jstl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/listener/">listener</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mail/">mail</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexT/">nexT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/">rabbitmq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/request/">request</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/response/">response</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/session/">session</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solr/">solr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-boot/">spring boot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlserver/">sqlserver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/struts2/">struts2</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/">vps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事务/">事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/回文数/">回文数</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/套路/">套路</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/泛型/">泛型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/激活码/">激活码</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">Nube de etiquetas</h3>
        <div class="widget tagcloud">
            <a href="/tags/Intellij/" style="font-size: 10px;">Intellij</a> <a href="/tags/activemq/" style="font-size: 10px;">activemq</a> <a href="/tags/annotaion/" style="font-size: 10px;">annotaion</a> <a href="/tags/ashx/" style="font-size: 10px;">ashx</a> <a href="/tags/cookie/" style="font-size: 10px;">cookie</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/el/" style="font-size: 10px;">el</a> <a href="/tags/filter/" style="font-size: 10px;">filter</a> <a href="/tags/hexo/" style="font-size: 12px;">hexo</a> <a href="/tags/hiberante/" style="font-size: 18px;">hiberante</a> <a href="/tags/io/" style="font-size: 10px;">io</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jdbc/" style="font-size: 14px;">jdbc</a> <a href="/tags/jdk/" style="font-size: 10px;">jdk</a> <a href="/tags/jsp/" style="font-size: 10px;">jsp</a> <a href="/tags/jstl/" style="font-size: 10px;">jstl</a> <a href="/tags/linux/" style="font-size: 16px;">linux</a> <a href="/tags/listener/" style="font-size: 10px;">listener</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nexT/" style="font-size: 10px;">nexT</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/rabbitmq/" style="font-size: 10px;">rabbitmq</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/request/" style="font-size: 10px;">request</a> <a href="/tags/response/" style="font-size: 10px;">response</a> <a href="/tags/session/" style="font-size: 10px;">session</a> <a href="/tags/solr/" style="font-size: 10px;">solr</a> <a href="/tags/spring/" style="font-size: 14px;">spring</a> <a href="/tags/spring-boot/" style="font-size: 10px;">spring boot</a> <a href="/tags/sqlserver/" style="font-size: 10px;">sqlserver</a> <a href="/tags/struts2/" style="font-size: 14px;">struts2</a> <a href="/tags/vps/" style="font-size: 10px;">vps</a> <a href="/tags/web/" style="font-size: 16px;">web</a> <a href="/tags/事务/" style="font-size: 10px;">事务</a> <a href="/tags/回文数/" style="font-size: 10px;">回文数</a> <a href="/tags/套路/" style="font-size: 12px;">套路</a> <a href="/tags/泛型/" style="font-size: 10px;">泛型</a> <a href="/tags/激活码/" style="font-size: 10px;">激活码</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">Links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 xxyxpy<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>